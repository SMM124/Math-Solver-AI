<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Math Solver AI - Pro</title>
    
    <!-- Favicon using the AI Logo (SVG Data URI) -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%234F46E5'/%3E%3Cstop offset='50%25' stop-color='%238B5CF6'/%3E%3Cstop offset='100%25' stop-color='%23EC4899'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath d='M25,50 C25,30 40,30 50,50 C60,70 75,70 75,50 C75,30 60,30 50,50 C40,70 25,70 25,50 Z' fill='none' stroke='url(%23g)' stroke-width='10' stroke-linecap='round'/%3E%3C/svg%3E" type="image/svg+xml">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                        display: ['Lexend', 'sans-serif'],
                    },
                    animation: {
                        'spin-slow': 'spin 8s linear infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-glow': 'pulse-glow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'slide-up-fade': 'slideUpFade 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                        'scale-in': 'scaleIn 0.2s ease-out',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        'pulse-glow': {
                            '0%, 100%': { opacity: 1, boxShadow: '0 0 20px rgba(99, 102, 241, 0.5)' },
                            '50%': { opacity: .7, boxShadow: '0 0 10px rgba(99, 102, 241, 0.2)' },
                        },
                        slideUpFade: {
                            '0%': { opacity: 0, transform: 'translateY(10px)' },
                            '100%': { opacity: 1, transform: 'translateY(0)' },
                        },
                        scaleIn: {
                            '0%': { transform: 'scale(0.95)', opacity: 0 },
                            '100%': { transform: 'scale(1)', opacity: 1 },
                        }
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.37)',
                        'neon': '0 0 10px rgba(99, 102, 241, 0.5), 0 0 20px rgba(99, 102, 241, 0.3)',
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Lexend:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Import Maps for React & Libraries -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client?deps=react@18.2.0",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0?deps=react@18.2.0",
            "react-markdown": "https://esm.sh/react-markdown@9.0.1?deps=react@18.2.0",
            "katex": "https://esm.sh/katex@0.16.9",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
        }
    }
    </script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        
        /* Glassmorphism Utilities */
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .dark .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glass-button {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s ease;
        }
        .glass-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        /* --- Invisible Scrollbar Utility (Updated) --- */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* --- Custom Scrollbar for Code/Math Blocks AND General UI --- */
        .custom-scrollbar::-webkit-scrollbar {
            height: 6px;
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(156, 163, 175, 0.5);
            border-radius: 20px;
        }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(75, 85, 99, 0.5);
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: rgba(107, 114, 128, 0.8);
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-slate-950 transition-colors duration-500">
    <div id="root"></div>

    <!-- Main Application Script -->
    <script type="text/babel" data-type="module">
        import React, { useState, useRef, useEffect } from 'react';
        import ReactDOM from 'react-dom/client';
        import { Menu, Plus, Settings, Send, X, Sparkles, Lightbulb, Trash2, ThumbsUp, ThumbsDown, Copy, Check, FileText, Globe, RefreshCw, Download, User, Moon, Sun, History, Asterisk, Triangle, Sigma, Variable, Share2, LogOut, Eye, EyeOff, Type, Languages, AlertTriangle, ArrowRight, Lock, Mail, ChevronRight, MessageSquare, Zap, LayoutGrid, Monitor, Camera, Edit2, Key } from 'lucide-react';
        import ReactMarkdown from 'react-markdown';
        import katex from 'katex';
        
        // Firebase Imports
        import { initializeApp } from "firebase/app";
        import { 
            getAuth, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut,
            setPersistence,
            browserLocalPersistence,
            updateProfile 
        } from "firebase/auth";
        import { 
            getFirestore, 
            doc, 
            addDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query,
            arrayUnion,
            updateDoc,
            serverTimestamp,
            getDocs,
            writeBatch,
            setDoc,
            getDoc
        } from "firebase/firestore";

        // --- START: Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDW4gCKg1ojKjvBwgcU3rfFNvkW6_jy-KQ",
            authDomain: "math-solv.firebaseapp.com",
            projectId: "math-solv",
            storageBucket: "math-solv.firebasestorage.app",
            messagingSenderId: "798961802726",
            appId: "1:798961802726:web:d7f12d3248522e63540a27",
        };
        // --- END: Firebase Configuration ---

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- SAFE LOCAL STORAGE HELPER ---
        const safeLocalStorage = {
            getItem: (key) => {
                try {
                    return localStorage.getItem(key);
                } catch (e) {
                    console.warn('LocalStorage access denied', e);
                    return null;
                }
            },
            setItem: (key, value) => {
                try {
                    localStorage.setItem(key, value);
                } catch (e) {
                    console.warn('LocalStorage access denied', e);
                }
            },
            removeItem: (key) => {
                try {
                    localStorage.removeItem(key);
                } catch (e) {
                    console.warn('LocalStorage access denied', e);
                }
            }
        };

        // --- DEFAULT API KEY (Hardcoded Fallback) ---
        const defaultApiKey = ""; // Add your hardcoded key here if needed

        // Inject Katex CSS dynamically
        const useKatexStyles = () => {
            useEffect(() => {
                // Link is already in head
            }, []);
        };

        const InlineMath = ({ math }) => {
            try {
                const html = katex.renderToString(math, { throwOnError: false, displayMode: false });
                return <span dangerouslySetInnerHTML={{ __html: html }} className="inline-block" />;
            } catch (e) {
                return <span className="font-mono text-red-400">{math}</span>;
            }
        };

        const BlockMath = ({ math }) => {
            try {
                const html = katex.renderToString(math, { throwOnError: false, displayMode: true });
                return <div className="my-4 overflow-x-auto custom-scrollbar p-2 rounded-lg bg-gray-50/50 dark:bg-slate-900/50" dangerouslySetInnerHTML={{ __html: html }} />;
            } catch (e) {
                return <div className="font-mono text-red-400 my-4">{math}</div>;
            }
        };

        // --- NEW COMPONENT: CODE BLOCK WITH COPY BUTTON ---
        const CodeBlock = ({ language, children, isDarkMode, isUserMessage }) => {
            const [copied, setCopied] = useState(false);

            const handleCopy = () => {
                navigator.clipboard.writeText(String(children).replace(/\n$/, ''));
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };

            return (
                <div className="my-4 rounded-xl overflow-hidden border shadow-sm transition-all duration-200 hover:shadow-md border-gray-200 dark:border-gray-700">
                    {/* Code Header */}
                    <div className={`flex items-center justify-between px-4 py-2 border-b ${isDarkMode ? 'bg-slate-800 border-gray-700' : 'bg-gray-100 border-gray-200'}`}>
                        <span className={`text-xs font-bold uppercase font-mono tracking-wider ${isDarkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                            {language || 'Code'}
                        </span>
                        <button 
                            onClick={handleCopy}
                            className="flex items-center gap-1.5 text-xs font-medium text-indigo-500 hover:text-indigo-400 transition-colors focus:outline-none"
                            title="Copy code"
                        >
                            {copied ? (
                                <>
                                    <Check size={14} className="text-emerald-500" />
                                    <span className="text-emerald-500">Copied!</span>
                                </>
                            ) : (
                                <>
                                    <Copy size={14} />
                                    <span>Copy</span>
                                </>
                            )}
                        </button>
                    </div>
                    {/* Code Body */}
                    <pre className={`relative m-0 p-4 overflow-x-auto custom-scrollbar ${isUserMessage ? 'bg-black/20 text-white' : (isDarkMode ? 'bg-slate-900 text-indigo-300' : 'bg-gray-50 text-indigo-700')}`}>
                        <code className="text-sm font-mono leading-relaxed whitespace-pre">
                            {children}
                        </code>
                    </pre>
                </div>
            );
        };

        // --- REUSABLE MARKDOWN COMPONENTS FOR CONSISTENT STYLING ---
        const getMarkdownComponents = (isDarkMode, isUserMessage) => {
            // Helper to determine text color
            const textColor = isUserMessage 
                ? 'text-white/95' 
                : (isDarkMode ? 'text-slate-300' : 'text-slate-700');
            
            const headingColor = isUserMessage
                ? 'text-white'
                : (isDarkMode ? 'text-indigo-300' : 'text-indigo-800');

            const borderColor = isUserMessage
                ? 'border-white/20'
                : (isDarkMode ? 'border-gray-700' : 'border-gray-200');

            return {
                h1: ({node, ...props}) => <h1 className={`text-2xl font-bold mt-6 mb-4 font-display border-b pb-2 ${headingColor} ${borderColor}`} {...props} />,
                h2: ({node, ...props}) => <h2 className={`text-xl font-bold mt-5 mb-3 font-display ${isUserMessage ? 'text-white' : (isDarkMode ? 'text-indigo-200' : 'text-indigo-700')}`} {...props} />,
                h3: ({node, ...props}) => <h3 className={`text-lg font-bold mt-4 mb-2 font-display ${isUserMessage ? 'text-white/90' : (isDarkMode ? 'text-indigo-100' : 'text-indigo-600')}`} {...props} />,
                p: ({node, ...props}) => <p className={`mb-3 leading-relaxed text-base ${textColor}`} {...props} />,
                strong: ({node, ...props}) => <strong className={`font-bold ${isUserMessage ? 'text-white' : (isDarkMode ? 'text-indigo-400' : 'text-indigo-700')}`} {...props} />,
                em: ({node, ...props}) => <em className={`italic ${isUserMessage ? 'text-white/80' : (isDarkMode ? 'text-purple-300' : 'text-purple-600')}`} {...props} />,
                blockquote: ({node, ...props}) => <blockquote className={`border-l-4 pl-4 py-2 my-4 italic rounded-r bg-opacity-50 ${isUserMessage ? 'border-white/50 bg-white/10 text-white/90' : (isDarkMode ? 'border-indigo-500 bg-indigo-900/20 text-slate-400' : 'border-indigo-600 bg-indigo-50 text-slate-600')}`} {...props} />,
                ul: ({node, ...props}) => <ul className={`list-disc pl-6 mb-4 space-y-2 ${isUserMessage ? 'marker:text-white/80' : 'marker:text-indigo-500'}`} {...props} />,
                ol: ({node, ...props}) => <ol className={`list-decimal pl-6 mb-4 space-y-2 ${isUserMessage ? 'marker:text-white/80' : 'marker:text-indigo-500'}`} {...props} />,
                li: ({node, ...props}) => <li className={`pl-1 ${textColor}`} {...props} />,
                a: ({node, ...props}) => <a className={`${isUserMessage ? 'text-white underline decoration-white/50 hover:decoration-white' : 'text-blue-500 hover:underline'} cursor-pointer font-medium`} target="_blank" rel="noopener noreferrer" {...props} />,
                hr: ({node, ...props}) => <hr className={`my-6 border-t ${borderColor}`} {...props} />,
                code: ({node, inline, className, children, ...props}) => {
                    if (!inline) {
                        const match = /language-(\w+)/.exec(className || '');
                        const lang = match ? match[1] : '';
                        return (
                            <CodeBlock language={lang} isDarkMode={isDarkMode} isUserMessage={isUserMessage}>
                                {children}
                            </CodeBlock>
                        );
                    }
                    return (
                        <code className={`${isUserMessage ? 'bg-white/20 text-white border-white/20' : (isDarkMode ? 'bg-slate-800 text-indigo-300 border-slate-700' : 'bg-gray-100 text-indigo-700 border-gray-200')} px-1.5 py-0.5 rounded border text-xs font-mono tracking-tight`} {...props}>{children}</code>
                    );
                }
            };
        };

        // --- Helper Component to Render Text mixed with Math ---
        const TextWithMath = ({ content, isDarkMode, isUserMessage }) => {
            const parts = content.split(/(\$\$[\s\S]*?\$\$|\$[\s\S]*?\$)/g);
            const markdownComponents = getMarkdownComponents(isDarkMode, isUserMessage);
            
            return (
                <>
                    {parts.map((part, index) => {
                        if (part.startsWith('$$') && part.endsWith('$$')) {
                            return <BlockMath key={index} math={part.slice(2, -2)} />;
                        } else if (part.startsWith('$') && part.endsWith('$')) {
                            return <InlineMath key={index} math={part.slice(1, -1)} />;
                        } else {
                            return (
                                <ReactMarkdown
                                    key={index}
                                    components={markdownComponents}
                                >
                                    {part}
                                </ReactMarkdown>
                            );
                        }
                    })}
                </>
            );
        };

        // --- Improved Custom Table Component with Math Support ---
        const SimpleTable = ({ content, isDarkMode }) => {
            const lines = content.trim().split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) return null;

            const parseRow = (rowStr) => {
                return rowStr
                    .trim()
                    .replace(/^\|/, '') // Remove leading pipe
                    .replace(/\|$/, '') // Remove trailing pipe
                    .split('|')
                    .map(cell => cell.trim());
            };

            const headerCells = parseRow(lines[0]);
            const bodyLines = lines.slice(2); // Skip header and separator line

            return (
                <div className="overflow-hidden my-6 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm">
                    <div className="overflow-x-auto custom-scrollbar">
                        <table className={`min-w-full divide-y ${isDarkMode ? 'divide-gray-700 bg-slate-800/50' : 'divide-gray-200 bg-white/50'} text-left text-sm backdrop-blur-sm`}>
                            <thead className={isDarkMode ? 'bg-slate-800' : 'bg-gray-50'}>
                                <tr>
                                    {headerCells.map((head, i) => (
                                        <th key={i} className={`px-4 py-3 font-semibold uppercase tracking-wider text-xs ${isDarkMode ? 'text-indigo-300 border-gray-600' : 'text-indigo-600 border-gray-200'} border-b`}>
                                            <TextWithMath content={head} isDarkMode={isDarkMode} />
                                        </th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody className={`divide-y ${isDarkMode ? 'divide-gray-700' : 'divide-gray-200'} bg-transparent`}>
                                {bodyLines.map((line, i) => {
                                    const cells = parseRow(line);
                                    return (
                                        <tr key={i} className={`transition-colors ${isDarkMode ? 'hover:bg-slate-700/50' : 'hover:bg-indigo-50/50'}`}>
                                            {cells.map((cell, j) => (
                                                <td key={j} className={`px-4 py-3 ${isDarkMode ? 'text-slate-300 border-gray-700' : 'text-slate-700 border-gray-100'} border-r last:border-r-0`}>
                                                        <TextWithMath content={cell} isDarkMode={isDarkMode} />
                                                </td>
                                            ))}
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const MarkdownRenderer = ({ content, isDarkMode, fontSize, isUserMessage }) => {
            useKatexStyles();
            
            const fontSizeClass = {
                'small': 'text-sm',
                'normal': 'text-base',
                'large': 'text-lg'
            }[fontSize] || 'text-base';

            const markdownComponents = getMarkdownComponents(isDarkMode, isUserMessage);

            const renderContent = () => {
                if (content.startsWith('data:image/') || (content.startsWith('http') && (content.endsWith('.png') || content.endsWith('.jpg') || content.endsWith('.jpeg')))) {
                    return (
                        <div className="relative group rounded-2xl overflow-hidden shadow-lg my-2">
                            <img src={content} alt="Generated" className="w-full h-auto object-cover transition-transform duration-500 group-hover:scale-105" />
                            <div className="absolute inset-0 ring-1 ring-inset ring-black/10 rounded-2xl pointer-events-none"></div>
                        </div>
                    );
                }

                const codeBlockRegex = /(```[\s\S]*?```)/g;
                const codeParts = content.split(codeBlockRegex);

                return codeParts.map((codePart, cIndex) => {
                    if (codePart.startsWith('```')) {
                            return (
                                <ReactMarkdown 
                                    key={cIndex} 
                                    components={markdownComponents}
                                >
                                    {codePart}
                                </ReactMarkdown>
                            );
                    }

                    const tableRegex = /((?:(?:^|\n)\|[^\n]+\|)+\r?\n(?:\|[-:| ]+\|)(?:\r?\n\|[^\n]+\|)+)/g;
                    const tableParts = codePart.split(tableRegex);

                    return (
                        <span key={cIndex}>
                            {tableParts.map((part, tIndex) => {
                                if (part.match(/\|[-:| ]+\|/)) {
                                    return <SimpleTable key={tIndex} content={part} isDarkMode={isDarkMode} />;
                                }
                                return <TextWithMath key={tIndex} content={part} isDarkMode={isDarkMode} isUserMessage={isUserMessage} />;
                            })}
                        </span>
                    );
                });
            };
            return <div className={`prose max-w-none ${isDarkMode ? 'prose-invert' : ''} font-inter ${fontSizeClass} leading-relaxed`}>{renderContent()}</div>;
        };

        // --- UPDATED ANIMATED LOGO COMPONENT ---
        const MathSolverAILogo = ({ size = 24, className = '' }) => {
            return (
                <div className={`relative flex items-center justify-center ${className}`} style={{ width: size, height: size }}>
                <svg viewBox="0 0 100 100" className="w-full h-full overflow-visible">
                    <defs>
                    <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stopColor="#4F46E5" /> {/* Indigo-600 */}
                        <stop offset="50%" stopColor="#8B5CF6" /> {/* Violet-500 */}
                        <stop offset="100%" stopColor="#EC4899" /> {/* Pink-500 */}
                    </linearGradient>
                    <filter id="glow">
                        <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                        <feMerge>
                        <feMergeNode in="coloredBlur"/>
                        <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                    </defs>
                    
                    {/* Glowing Infinity/Möbius Strip */}
                    <path
                        d="M25,50 C25,30 40,30 50,50 C60,70 75,70 75,50 C75,30 60,30 50,50 C40,70 25,70 25,50 Z"
                        fill="none"
                        stroke="url(#logoGradient)"
                        strokeWidth="8"
                        strokeLinecap="round"
                        filter="url(#glow)"
                        className="animate-pulse-glow"
                    />
                    
                    {/* Orbiting Particle 1 */}
                    <circle r="4" fill="#fff">
                        <animateMotion 
                            dur="4s" 
                            repeatCount="indefinite" 
                            path="M25,50 C25,30 40,30 50,50 C60,70 75,70 75,50 C75,30 60,30 50,50 C40,70 25,70 25,50 Z"
                        />
                    </circle>

                     {/* Orbiting Particle 2 (Delayed) */}
                     <circle r="3" fill="#A5B4FC">
                        <animateMotion 
                            dur="4s" 
                            begin="2s"
                            repeatCount="indefinite" 
                            path="M25,50 C25,30 40,30 50,50 C60,70 75,70 75,50 C75,30 60,30 50,50 C40,70 25,70 25,50 Z"
                        />
                    </circle>
                </svg>
                </div>
            );
        };

        // --- ADVANCED AUTH MODAL COMPONENT ---
        const AuthModal = ({ isDarkMode }) => {
            const [name, setName] = useState('');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isSigningUp, setIsSigningUp] = useState(false); 
            const [authError, setAuthError] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [showPassword, setShowPassword] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                setAuthError('');

                try {
                    await setPersistence(auth, browserLocalPersistence);
                    
                    if (isSigningUp) {
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        await updateProfile(userCredential.user, {
                            displayName: name
                        });
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (error) {
                    let msg = error.message.replace('Firebase: ', '');
                    if(msg.includes('auth/invalid-email')) msg = "Invalid email address.";
                    if(msg.includes('auth/user-not-found')) msg = "No account found with this email.";
                    if(msg.includes('auth/wrong-password')) msg = "Incorrect password.";
                    if(msg.includes('auth/email-already-in-use')) msg = "Email already in use.";
                    setAuthError(msg);
                    setIsLoading(false);
                }
            };

            return (
                <div className={`fixed inset-0 z-50 flex items-center justify-center p-4 bg-cover bg-center transition-all duration-700`} style={{
                    backgroundImage: `url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2072&auto=format&fit=crop')`,
                }}>
                    <div className={`absolute inset-0 ${isDarkMode ? 'bg-slate-950/80' : 'bg-indigo-950/70'} backdrop-blur-md`}></div>

                    <div className={`relative flex w-full max-w-4xl h-auto min-h-[500px] md:h-[650px] rounded-3xl overflow-hidden shadow-2xl animate-scale-in flex-col md:flex-row glass-panel border-0`}>
                        
                        {/* Left Side */}
                        <div className={`hidden md:flex w-1/2 flex-col justify-center items-center p-12 relative overflow-hidden text-white`}>
                            <div className="absolute inset-0 bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 opacity-90 mix-blend-overlay"></div>
                            <div className="absolute inset-0 bg-black/10"></div>
                            <div className="relative z-10 flex flex-col items-center text-center">
                                <div className="mb-8 scale-150 animate-float">
                                    <MathSolverAILogo size={140} />
                                </div>
                                <h1 className="text-5xl font-display font-extrabold mb-4 tracking-tight drop-shadow-lg">Math Solver</h1>
                                <p className="text-lg text-indigo-50 font-medium drop-shadow-md">Unlock your potential with intelligent problem solving.</p>
                            </div>
                        </div>

                        {/* Right Side */}
                        <div className={`w-full md:w-1/2 p-8 md:p-12 flex flex-col justify-center relative ${isDarkMode ? 'text-white' : 'text-slate-800'}`}>
                            <div className="mb-8 text-center md:text-left">
                                <h2 className="text-3xl font-bold font-display mb-2">{isSigningUp ? 'Create Account' : 'Welcome Back'}</h2>
                                <p className={`text-sm ${isDarkMode ? 'text-slate-400' : 'text-slate-500'}`}>{isSigningUp ? 'Join us to solve math problems instantly.' : 'Enter your details to continue.'}</p>
                            </div>

                            <form onSubmit={handleSubmit} className="space-y-5">
                                {isSigningUp && (
                                    <div className="space-y-1 animate-slide-up-fade">
                                        <label className={`text-xs font-bold uppercase tracking-wide ml-1 ${isDarkMode ? 'text-slate-400' : 'text-slate-500'}`} htmlFor="name">Full Name</label>
                                        <div className="relative group">
                                            <User className={`absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 transition-colors ${isDarkMode ? 'text-slate-500 group-focus-within:text-indigo-400' : 'text-slate-400 group-focus-within:text-indigo-600'}`} />
                                            <input
                                                type="text"
                                                id="name"
                                                value={name}
                                                onChange={(e) => setName(e.target.value)}
                                                required={isSigningUp}
                                                placeholder="Your Name"
                                                className={`w-full pl-10 pr-4 py-3.5 rounded-xl transition-all border outline-none ${isDarkMode ? 'bg-slate-800/50 border-slate-700 focus:border-indigo-500 text-white placeholder-slate-500' : 'bg-slate-50 border-slate-200 focus:border-indigo-500 text-slate-900 placeholder-slate-400'} focus:ring-2 focus:ring-indigo-500/20`}
                                            />
                                        </div>
                                    </div>
                                )}

                                <div className="space-y-1">
                                    <label className={`text-xs font-bold uppercase tracking-wide ml-1 ${isDarkMode ? 'text-slate-400' : 'text-slate-500'}`} htmlFor="email">Email</label>
                                    <div className="relative group">
                                        <Mail className={`absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 transition-colors ${isDarkMode ? 'text-slate-500 group-focus-within:text-indigo-400' : 'text-slate-400 group-focus-within:text-indigo-600'}`} />
                                        <input
                                            type="email"
                                            id="email"
                                            value={email}
                                            onChange={(e) => setEmail(e.target.value)}
                                            required
                                            placeholder="name@example.com"
                                            className={`w-full pl-10 pr-4 py-3.5 rounded-xl transition-all border outline-none ${isDarkMode ? 'bg-slate-800/50 border-slate-700 focus:border-indigo-500 text-white placeholder-slate-500' : 'bg-slate-50 border-slate-200 focus:border-indigo-500 text-slate-900 placeholder-slate-400'} focus:ring-2 focus:ring-indigo-500/20`}
                                        />
                                    </div>
                                </div>

                                <div className="space-y-1">
                                    <label className={`text-xs font-bold uppercase tracking-wide ml-1 ${isDarkMode ? 'text-slate-400' : 'text-slate-500'}`} htmlFor="password">Password</label>
                                    <div className="relative group">
                                        <Lock className={`absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 transition-colors ${isDarkMode ? 'text-slate-500 group-focus-within:text-indigo-400' : 'text-slate-400 group-focus-within:text-indigo-600'}`} />
                                        <input
                                            type={showPassword ? 'text' : 'password'}
                                            id="password"
                                            value={password}
                                            onChange={(e) => setPassword(e.target.value)}
                                            required
                                            minLength={6}
                                            placeholder="••••••••"
                                            className={`w-full pl-10 pr-12 py-3.5 rounded-xl transition-all border outline-none ${isDarkMode ? 'bg-slate-800/50 border-slate-700 focus:border-indigo-500 text-white placeholder-slate-500' : 'bg-slate-50 border-slate-200 focus:border-indigo-500 text-slate-900 placeholder-slate-400'} focus:ring-2 focus:ring-indigo-500/20`}
                                        />
                                        <button
                                            type="button"
                                            onClick={() => setShowPassword(!showPassword)}
                                            className={`absolute inset-y-0 right-0 px-3 flex items-center transition-colors ${isDarkMode ? 'text-slate-500 hover:text-slate-300' : 'text-slate-400 hover:text-slate-600'}`}
                                        >
                                            {showPassword ? <EyeOff size={18} /> : <Eye size={18} />}
                                        </button>
                                    </div>
                                </div>

                                {authError && (
                                    <div className="flex items-center gap-2 text-sm text-red-500 bg-red-500/10 p-3 rounded-xl animate-scale-in border border-red-500/20">
                                        <AlertTriangle size={16} />
                                        <span>{authError}</span>
                                    </div>
                                )}

                                <button
                                    type="submit"
                                    disabled={isLoading}
                                    className="group relative w-full py-3.5 px-4 rounded-xl font-bold text-white bg-gradient-to-r from-indigo-600 to-pink-600 hover:from-indigo-500 hover:to-pink-500 shadow-lg shadow-indigo-500/20 transition-all duration-300 active:scale-[0.98] disabled:opacity-70 disabled:cursor-not-allowed overflow-hidden mt-4"
                                >
                                    <div className="absolute inset-0 bg-white/20 translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700 ease-in-out"></div>
                                    {isLoading ? (
                                        <div className="flex items-center justify-center gap-2">
                                            <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                                            <span>Processing...</span>
                                        </div>
                                    ) : (
                                        <span className="flex items-center justify-center gap-2">
                                            {isSigningUp ? 'Create Account' : 'Sign In'} <ArrowRight size={18} />
                                        </span>
                                    )}
                                </button>
                            </form>

                            <div className="mt-8 text-center">
                                <p className={`text-sm ${isDarkMode ? 'text-slate-400' : 'text-slate-500'}`}>
                                    {isSigningUp ? 'Already have an account?' : "Don't have an account?"}
                                    <button
                                        type="button"
                                        onClick={() => { setIsSigningUp(!isSigningUp); setAuthError(''); setName(''); }}
                                        className="font-bold text-indigo-500 hover:text-indigo-400 ml-1 hover:underline transition-colors"
                                    >
                                        {isSigningUp ? 'Sign In' : 'Sign Up'}
                                    </button>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- CUSTOM CONFIRMATION MODAL ---
        const ConfirmModal = ({ isOpen, title, message, onConfirm, onCancel, isDarkMode }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm animate-fade-in">
                    <div className={`w-full max-w-sm rounded-2xl shadow-2xl p-6 transform scale-100 animate-scale-in border ${isDarkMode ? 'bg-slate-900 border-slate-700' : 'bg-white border-slate-200'}`}>
                        <h3 className={`text-lg font-bold font-display mb-2 ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>{title}</h3>
                        <p className={`text-sm mb-6 ${isDarkMode ? 'text-slate-400' : 'text-slate-600'}`}>{message}</p>
                        <div className="flex justify-end gap-3">
                            <button onClick={onCancel} className={`px-4 py-2 rounded-xl text-sm font-semibold transition-colors ${isDarkMode ? 'bg-slate-800 text-slate-300 hover:bg-slate-700' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}`}>Cancel</button>
                            <button onClick={onConfirm} className="px-4 py-2 rounded-xl text-sm font-semibold text-white bg-red-500 hover:bg-red-600 transition-colors shadow-lg shadow-red-500/20">Delete</button>
                        </div>
                    </div>
                </div>
            );
        };


        function App() {
            // useInterFont(); // Removing this line
            const [currentUser, setCurrentUser] = useState(null);
            const [isAuthLoading, setIsAuthLoading] = useState(true);
            const [isSidebarOpen, setIsSidebarOpen] = useState(window.innerWidth > 768);
            const [messages, setMessages] = useState([]);
            const [inputValue, setInputValue] = useState('');
            const [loadingState, setLoadingState] = useState('idle');
            const [showLanding, setShowLanding] = useState(true);
            const [showSettings, setShowSettings] = useState(false);
            const [recentChats, setRecentChats] = useState([]);
            const [currentChatId, setCurrentChatId] = useState(null);
            const [isDarkMode, setIsDarkMode] = useState(true);
            const [copiedMessageId, setCopiedMessageId] = useState(null);
            const [attachments, setAttachments] = useState([]);
            const [feedbacks, setFeedbacks] = useState({});
            const [fontSize, setFontSize] = useState('normal'); 
            const [language, setLanguage] = useState('auto');
            const [userPhoto, setUserPhoto] = useState(null); 
            
            // --- API Key States ---
            const [customApiKey, setCustomApiKey] = useState(safeLocalStorage.getItem('math_solver_api_key') || '');
            const [tempApiKey, setTempApiKey] = useState(safeLocalStorage.getItem('math_solver_api_key') || '');
            const [apiStatus, setApiStatus] = useState(safeLocalStorage.getItem('math_solver_api_key') ? 'valid' : 'idle'); 

            // States for deletion confirmation
            const [confirmModal, setConfirmModal] = useState({ isOpen: false, type: null, id: null });
            
            const messagesEndRef = useRef(null);
            const inputRef = useRef(null);
            const fileInputRef = useRef(null);
            const readingTimeoutRef = useRef(null);
            const profilePhotoInputRef = useRef(null);

            useEffect(() => {
                const handleResize = () => {
                    if (window.innerWidth > 768) {
                        setIsSidebarOpen(true);
                    } else {
                        setIsSidebarOpen(false);
                    }
                };
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            // --- STRICT AUTH PERSISTENCE FIX ---
            useEffect(() => {
                // Ensure local persistence is enabled
                setPersistence(auth, browserLocalPersistence)
                    .catch((error) => console.error("Persistence failed:", error));

                // Standard and robust auth listener
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    if (user) {
                        setCurrentUser(user);
                    } else {
                        setCurrentUser(null);
                        // Clean up local state on logout/timeout
                        setMessages([]);
                        setRecentChats([]);
                        setCurrentChatId(null);
                        setShowLanding(true);
                        setUserPhoto(null);
                    }
                    setIsAuthLoading(false);
                });

                return () => unsubscribe();
            }, []);

            // --- FETCH USER PROFILE PHOTO FROM FIRESTORE ---
            useEffect(() => {
                if (!currentUser) return;

                const userDocRef = doc(db, 'users', currentUser.uid);
                
                // Real-time listener for user document changes (like photo update)
                const unsubscribe = onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.photoBase64) {
                            setUserPhoto(data.photoBase64);
                        }
                    }
                });

                return () => unsubscribe();
            }, [currentUser]);


            useEffect(() => {
                if (!currentUser) {
                    setRecentChats([]);
                    return;
                }
                
                const chatsCollectionRef = collection(db, 'users', currentUser.uid, 'chats');
                const q = query(chatsCollectionRef); 
                
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const chats = [];
                    querySnapshot.forEach((doc) => {
                        chats.push({ id: doc.id, ...doc.data() });
                    });
                    chats.sort((a, b) => (b.lastUpdated?.seconds || 0) - (a.lastUpdated?.seconds || 0));
                    setRecentChats(chats);
                }, (error) => {
                    console.error("Error listening to chat list:", error);
                });

                return () => unsubscribe();
            }, [currentUser]);

            useEffect(() => {
                if (!currentUser || !currentChatId) {
                    setMessages([]); 
                    return;
                }

                const chatDocRef = doc(db, 'users', currentUser.uid, 'chats', currentChatId);
                
                const unsubscribe = onSnapshot(chatDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        const restoredMessages = (data.messages || []).map(msg => {
                            if (msg.attachments) {
                                msg.attachments = msg.attachments.map(att => {
                                    if (att.preview === 'image_preview_placeholder') {
                                        return { ...att, preview: null };
                                    }
                                    return att;
                                });
                            }
                            if (msg.timestamp && typeof msg.timestamp.toDate === 'function') {
                                msg.timestamp = msg.timestamp.toDate().getTime();
                            }
                            return msg;
                        });
                        setMessages(restoredMessages);
                        setShowLanding(false);
                    } else {
                        console.warn("Could not find chat document:", currentChatId);
                        setMessages([]);
                        setShowLanding(true);
                        setCurrentChatId(null);
                    }
                }, (error) => {
                    console.error("Error listening to chat document:", error);
                });
                
                return () => unsubscribe();
            }, [currentUser, currentChatId]);


            useEffect(() => {
                return () => {
                if (readingTimeoutRef.current) clearTimeout(readingTimeoutRef.current);
                };
            }, []);

            const toggleSidebar = () => setIsSidebarOpen(!isSidebarOpen);
            const toggleSettings = () => setShowSettings(!showSettings);
            const toggleDarkMode = () => {
                setIsDarkMode(prev => {
                    const newMode = !prev;
                    if (newMode) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                    return newMode;
                });
            };
            
            useEffect(() => {
                if (isDarkMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }, [isDarkMode]);

            // --- API KEY VALIDATION FUNCTION ---
            const validateApiKey = async (key) => {
                if (!key) {
                    setApiStatus('idle');
                    setCustomApiKey('');
                    safeLocalStorage.removeItem('math_solver_api_key');
                    return;
                }
                
                setApiStatus('validating');
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: "Hello" }] }] })
                    });
                    
                    if (response.ok) {
                        setApiStatus('valid');
                        setCustomApiKey(key);
                        safeLocalStorage.setItem('math_solver_api_key', key);
                    } else {
                        setApiStatus('invalid');
                    }
                } catch (e) {
                    setApiStatus('invalid');
                }
            };

            // --- NEW SHARE FUNCTIONALITY ---
            const handleShare = async () => {
                const shareData = {
                    title: 'Math Solver AI',
                    text: 'Check out this amazing AI Math Solver!',
                    url: window.location.href,
                };

                try {
                    if (navigator.share) {
                        await navigator.share(shareData);
                    } else {
                        await navigator.clipboard.writeText(window.location.href);
                        alert('Link copied to clipboard!');
                    }
                } catch (err) {
                    console.error('Error sharing:', err);
                }
            };

            const startNewChat = () => {
                setShowLanding(true);
                setMessages([]); 
                setCurrentChatId(null);
                setFeedbacks({});
                setAttachments([]);
                if (window.innerWidth <= 768) setIsSidebarOpen(false);
            };

            const initiateDeleteChat = (e, chatId) => {
                e.stopPropagation();
                setConfirmModal({ isOpen: true, type: 'single', id: chatId });
            };

            const initiateClearAllChats = () => {
                setConfirmModal({ isOpen: true, type: 'all', id: null });
            };

            const confirmAction = async () => {
                if (!currentUser) return;
                const { type, id } = confirmModal;
                setConfirmModal({ isOpen: false, type: null, id: null }); // Close modal first

                try {
                    if (type === 'single' && id) {
                        const chatDocRef = doc(db, 'users', currentUser.uid, 'chats', id);
                        await deleteDoc(chatDocRef);
                        if (currentChatId === id) {
                            startNewChat();
                        }
                    } else if (type === 'all') {
                        const chatsCollectionRef = collection(db, 'users', currentUser.uid, 'chats');
                        const snapshot = await getDocs(chatsCollectionRef);
                        const batch = writeBatch(db);
                        
                        snapshot.docs.forEach((doc) => {
                            batch.delete(doc.ref);
                        });
                        
                        await batch.commit();
                        startNewChat();
                        setShowSettings(false);
                    } else if (type === 'current' && currentChatId) {
                        const chatDocRef = doc(db, 'users', currentUser.uid, 'chats', currentChatId);
                        await deleteDoc(chatDocRef);
                        startNewChat();
                    }
                } catch (error) {
                    console.error("Error executing delete action:", error);
                }
            };

            const loadChat = (chatId) => {
                setCurrentChatId(chatId);
                setFeedbacks({});
                setAttachments([]);
                if (window.innerWidth <= 768) setIsSidebarOpen(false);
            };

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [messages, loadingState]);

            const handleCopy = (text, id) => {
                try {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    textArea.style.position = "fixed";
                    textArea.style.left = "-9999px";
                    textArea.style.top = "0";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textArea);
                    if (successful) {
                        setCopiedMessageId(id);
                        setTimeout(() => setCopiedMessageId(null), 2000);
                    } else {
                        console.error('Fallback copy failed.');
                    }
                } catch (err) {
                    console.error('Copy failed', err);
                }
            };

            const handleFeedback = (index, type) => {
                setFeedbacks(prev => {
                    const currentFeedback = prev[index];
                    if (currentFeedback === type) {
                        const newFeedbacks = { ...prev };
                        delete newFeedbacks[index];
                        return newFeedbacks;
                    }
                    return { ...prev, [index]: type };
                });
            };

            const isImageGenerationRequest = (text) => {
                const lower = text.toLowerCase().trim();
                const enKeywords = ['draw', 'create image', 'generate image', 'make a picture', 'show me a picture of'];
                const bnKeywords = ['ছবি আঁক', 'ছবি তৈরি', 'ছবি বানাও', 'ছবি দেখাও'];
                return enKeywords.some(keyword => lower.startsWith(keyword)) || bnKeywords.some(keyword => lower.includes(keyword));
            }

            const handleSendMessage = async (text, isRegeneration = false) => {
                if (!currentUser) {
                    console.error("Cannot send message: no user logged in.");
                    return;
                }
                
                let query = text || inputValue;
                let currentAttachments = [...attachments];
                let historyForApi = [...messages];
                let activeChatId = currentChatId;

                const messageTimestamp = Date.now(); 

                const newUserMessage = { 
                    role: 'user', 
                    content: query, 
                    attachments: currentAttachments.map(att => ({ 
                        name: att.name, 
                        type: att.type, 
                        preview: att.preview ? 'image_preview_placeholder' : null 
                    })),
                    timestamp: messageTimestamp 
                };
                
                const attachmentsForApi = currentAttachments.map(att => ({
                    mimeType: att.type,
                    data: att.data
                }));

                if (isRegeneration) {
                    const lastUserMessageIdx = messages.findLastIndex(m => m.role === 'user');
                    if (lastUserMessageIdx === -1) return; 

                    query = messages[lastUserMessageIdx].content;
                    currentAttachments = []; 
                    
                    if (messages.length > lastUserMessageIdx + 1 && messages[messages.length - 1].role === 'model') {
                        historyForApi = messages.slice(0, -1);
                        setMessages(prev => prev.slice(0, -1)); 
                    }
                } else {
                    if (!query.trim() && attachments.length === 0) return;
                    setShowLanding(false);
                    setInputValue('');
                    setAttachments([]); 
                    if (inputRef.current) inputRef.current.style.height = 'auto';
                    
                    setMessages(prev => [...prev, { ...newUserMessage, attachments: currentAttachments, timestamp: messageTimestamp }]);
                    historyForApi = [...messages, { ...newUserMessage, attachments: currentAttachments }];
                }
                
                if (!activeChatId) {
                    try {
                        const firstMsg = historyForApi[0];
                        const title = (firstMsg.content && firstMsg.content.trim()) 
                            ? firstMsg.content.substring(0, 20) + (firstMsg.content.length > 20 ? '...' : '') 
                            : (firstMsg.attachments?.length > 0 ? firstMsg.attachments[0].name : 'New Chat');

                        const newChatRef = await addDoc(collection(db, 'users', currentUser.uid, 'chats'), {
                            title: title,
                            messages: [newUserMessage],
                            createdAt: serverTimestamp(),
                            lastUpdated: serverTimestamp()
                        });
                        activeChatId = newChatRef.id;
                        setCurrentChatId(newChatRef.id);
                    } catch (error) {
                        console.error("Error creating new chat:", error);
                        setLoadingState('idle');
                        setMessages(prev => prev.slice(0, -1));
                        return;
                    }
                } else if (!isRegeneration) {
                    try {
                        const chatDocRef = doc(db, 'users', currentUser.uid, 'chats', activeChatId);
                        await updateDoc(chatDocRef, {
                            messages: arrayUnion(newUserMessage),
                            lastUpdated: serverTimestamp()
                        });
                    } catch (error) {
                            console.error("Error saving user message:", error);
                    }
                }
                
                // Determine API Key to use
                const activeApiKey = customApiKey || defaultApiKey;

                if (!activeApiKey) {
                    setLoadingState('idle');
                    const errorMessage = { 
                        role: 'model', 
                        content: "API Key is missing. Please configure it in Settings.", 
                        timestamp: Date.now() 
                    };
                    setMessages(prev => [...prev, errorMessage]);
                    // setShowSettings(true); // REMOVED as requested
                    return;
                }

                if (isImageGenerationRequest(query) && attachmentsForApi.length === 0) {
                    setLoadingState('drawing');
                    try {
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${activeApiKey}`;
                        // FIX: Using standard payload format for predict
                        const payload = { instances: [{ prompt: query }], parameters: { sampleCount: 1 } };
                        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        
                        if (!response.ok) {
                                let errorMsg = "Image generation failed.";
                                try { 
                                    const errorBody = await response.json(); 
                                    // Improve error extraction
                                    errorMsg = errorBody.error?.message || errorBody.message || response.statusText; 
                                } catch (e) {
                                    errorMsg = response.statusText || "Unknown Error";
                                }
                                
                                console.error("API Error Details:", errorMsg); // Log for debugging

                                if (errorMsg.toLowerCase().includes('policy') || errorMsg.toLowerCase().includes('safety')) 
                                    throw new Error("দুঃখিত, আমি এই ধরনের ছবি তৈরি করতে পারছি না। এটি নিরাপত্তা নীতির বাইরে।");
                                
                                // Handle Billing Error Gracefully
                                if (errorMsg.toLowerCase().includes('billed') || errorMsg.toLowerCase().includes('billing') || errorMsg.includes('403'))
                                    throw new Error("দুঃখিত, ছবি তৈরির জন্য Google Cloud-এ বিলিং অ্যাকাউন্ট চালু থাকা প্রয়োজন। আপনার API Key টি ফ্রী টিয়ারের হতে পারে।");

                                // Show the actual error to help debugging (e.g., "API key not valid" or "Model not found")
                                throw new Error(`ছবি তৈরিতে সমস্যা: ${errorMsg}`);
                        }
                        const data = await response.json();
                        if (data.predictions && data.predictions[0]?.bytesBase64Encoded) {
                            const imageUrl = `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`;
                            const newModelMessage = { role: 'model', content: imageUrl, isImage: true, timestamp: Date.now() };
                            const chatDocRef = doc(db, 'users', currentUser.uid, 'chats', activeChatId);
                            await updateDoc(chatDocRef, { messages: arrayUnion(newModelMessage), lastUpdated: serverTimestamp() });
                        } else {
                                throw new Error("দুঃখিত, আমি এই অনুরোধটি প্রক্রিয়া করতে পারছি না। এটি আমাদের নিরাপত্তা নীতির বাইরে হতে পারে।");
                        }
                    } catch (error) {
                        console.error("Image Gen Error:", error);
                        // Clean up error message for display
                        let displayMsg = String(error.message).replace('Error: ', '');
                        const errorModelMessage = { role: 'model', content: displayMsg, isImage: false, timestamp: Date.now() };
                        const chatDocRef = doc(db, 'users', currentUser.uid, 'chats', activeChatId);
                        await updateDoc(chatDocRef, { messages: arrayUnion(errorModelMessage), lastUpdated: serverTimestamp() });
                    } finally {
                        setLoadingState('idle');
                    }
                    return;
                }

                if (attachmentsForApi.length > 0) {
                    setLoadingState('reading');
                    readingTimeoutRef.current = setTimeout(() => setLoadingState('thinking'), 2000);
                } else {
                    setLoadingState('thinking');
                }
                
                await callTextModel(query, attachmentsForApi, activeApiKey, historyForApi, isRegeneration, activeChatId);
            };

            const callTextModel = async (query, attachmentsForApi, apiKey, history, isRegeneration, activeChatId) => {
                let newModelMessage = { role: 'model', content: "Something went wrong.", isImage: false, timestamp: Date.now() }; 
                try {
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                    
                    let historyForPayload = [];
                    if (isRegeneration) {
                        const lastUserMessageIdx = history.findLastIndex(m => m.role === 'user');
                        historyForPayload = history.slice(0, lastUserMessageIdx);
                    } else {
                        historyForPayload = history.slice(0, -1);
                    }

                    const pastHistoryContents = historyForPayload
                        .filter(m => m.role === 'user' || (m.role === 'model' && !m.isImage)) 
                        .map(m => {
                            const contentText = (typeof m.content === 'string') ? m.content : '[Image Content]';
                            const parts = [{ text: contentText }];
                            if (m.role === 'user' && m.attachments?.length > 0) {
                                parts.push({ text: `\n[User also provided ${m.attachments.length} file(s) with this message.]` });
                            }
                            return { role: m.role, parts: parts };
                        });

                    const currentUserMessageParts = [{ text: query || "Analyze these attached files." }];
                    for (const att of attachmentsForApi) {
                        currentUserMessageParts.push({ inlineData: att });
                    }
                    
                    const payload = {
                        contents: [
                            ...pastHistoryContents, 
                            { role: "user", parts: currentUserMessageParts }
                        ],
                        systemInstruction: {
                        parts: [{ text: `You are "Math Solver" (গণিত সহায়ক), an advanced AI assistant.
                **Identity:**
                - Your Name: "Math Solver" or "গণিত সহায়ক".
                - Your Creator: "Md. Amzad Hossain Sadik" (মোঃ আমজাদ হুসাইন সাদিক). If asked who created you, you MUST state this name.
                
                **Core Directives:**
                1. **Language Mastery:** The user has selected '${language}'. If 'auto', detect language. If 'bn', respond in polite Bengali. If 'en', respond in English.
                2.  **Multimodal Analysis (Files/Images):** If files are attached, analyze them first. Identify math problems, text, or objects.
                3.  **Step-by-Step Logic:** For all problems, provide a detailed, numbered, step-by-step solution. Explain the 'why' behind formulas and steps.
                4.  **Markdown Formatting (Mandatory):**
                    -   Use **bold** for key terms and final answers.
                    -   Use Markdown tables for structured data (e.g., variable lists, comparisons).
                5.  **LaTeX Formatting (Mandatory):**
                    -   Use \`$$\` (double dollar signs) for all standalone or block-level mathematical equations.
                    -   Use \`$\` (single dollar signs) for all inline mathematical variables and simple expressions.
                6.  **Tone:** Professional, encouraging, and helpful, like an expert tutor.
                7.  **Safety:** If asked to generate or analyze inappropriate/obscene content, you MUST politely refuse. Respond: "দুঃখিত, আমি এই বিষয়ে আপনাকে সাহায্য করতে পারছি না।" (Sorry, I cannot help you with this topic.) Do not explain why.
                8.  **No Hallucinations:** If you don't know something, admit it politely.` }]
                        },
                        generationConfig: { 
                            temperature: 0.3, 
                            maxOutputTokens: 8192 
                        },
                        safetySettings: [
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }
                        ]
                    };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (readingTimeoutRef.current) clearTimeout(readingTimeoutRef.current);

                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API Error (${response.status}): ${errorBody.error?.message || 'Unknown error'}`);
                    }

                    const data = await response.json();

                    if (data.candidates && data.candidates.length > 0) {
                        const candidate = data.candidates[0];
                        
                        if (candidate.content?.parts?.[0]?.text) {
                            newModelMessage.content = candidate.content.parts[0].text;
                        } else if (candidate.finishReason === "SAFETY") {
                            newModelMessage.content = "দুঃখিত, আমি এই বিষয়ে আপনাকে সাহায্য করতে পারছি না।";
                        } else if (candidate.finishReason === "MAX_TOKENS") {
                            newModelMessage.content = (candidate.content?.parts?.[0]?.text || "") + "\n\n... (দুঃখিত, উত্তরটি সম্পূর্ণ করার আগেই শেষ হয়ে গেছে)";
                        } else if (candidate.finishReason === "STOP" && !candidate.content?.parts) {
                            newModelMessage.content = "দুঃখিত, একটি খালি প্রতিক্রিয়া পেয়েছি। অনুগ্রহ করে আবার চেষ্টা করুন।";
                        } else {
                            newModelMessage.content = "দুঃখিত, একটি অজানা ত্রুটি ঘটেছে। অনুগ্রহ করে আবার চেষ্টা করুন।";
                        }
                    } else {
                        const blockReason = data.promptFeedback?.blockReason;
                        if (blockReason) {
                            newModelMessage.content = "দুঃখিত, আমি এই বিষয়ে আপনাকে সাহায্য করতে পারছি না।";
                        } else {
                            console.error("API Response empty, no candidates", data);
                            newModelMessage.content = "দুঃখিত, একটি অজানা ত্রুটি ঘটেছে। অনুগ্রহ করে আবার চেষ্টা করুন।";
                        }
                    }
                } catch (error) {
                    console.error("Error in callTextModel:", error);
                    newModelMessage.content = `দুঃখিত, একটি নেটওয়ার্ক ত্রুটি ঘটেছে। আপনার সংযোগ পরীক্ষা করুন।`;
                } finally {
                    // Save the final model message (success or error) to Firestore
                    try {
                        if (activeChatId) {
                            const chatDocRef = doc(db, 'users', currentUser.uid, 'chats', activeChatId);
                            await updateDoc(chatDocRef, {
                                messages: arrayUnion(newModelMessage),
                                lastUpdated: serverTimestamp()
                            });
                        }
                    } catch (dbError) {
                        console.error("Error saving model message to Firestore:", dbError);
                    }
                    setLoadingState('idle');
                    setTimeout(() => inputRef.current?.focus(), 100);
                }
            }

            // AI Action Handler
            const handleAIAction = (action) => {
                if (messages.length === 0) return;
                
                let prompt = "";
                if (action === 'practice') {
                    prompt = "Give me a similar practice problem to solve based on the previous solution.";
                } else if (action === 'simplify') {
                    prompt = "Can you explain this again but in simpler terms?";
                }

                if (prompt) {
                    handleSendMessage(prompt);
                }
            };

            const handleDownloadImage = (imageUrl) => {
                const link = document.createElement('a');
                link.href = imageUrl;
                link.download = 'generated-image.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            const handleKeyDown = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSendMessage();
                }
            };

            const handleInputChange = (e) => {
                setInputValue(e.target.value);
                e.target.style.height = 'auto';
                e.target.style.height = `${Math.min(e.target.scrollHeight, 150)}px`;
            };

            const handleFileChange = async (e) => {
                const files = Array.from(e.target.files);
                if (!files.length) return;
                const newAttachments = await Promise.all(files.map(file => new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve({
                        name: file.name, type: file.type,
                        preview: file.type.startsWith('image/') ? reader.result : null,
                        data: reader.result.split(',')[1] // base64 data
                    });
                    reader.readAsDataURL(file);
                })));
                setAttachments(prev => [...prev, ...newAttachments]);
                if (fileInputRef.current) fileInputRef.current.value = '';
                inputRef.current?.focus();
            };

            // --- PROFILE PHOTO UPLOAD HANDLER ---
            const handleProfilePhotoUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = async () => {
                        const canvas = document.createElement('canvas');
                        // Resize for performance/storage limit
                        const MAX_WIDTH = 150; 
                        const MAX_HEIGHT = 150;
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext("2d");
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Compress to Base64 (JPEG quality 0.7)
                        const dataUrl = canvas.toDataURL("image/jpeg", 0.7); 
                        
                        // Save to Firestore
                        try {
                            const userDocRef = doc(db, 'users', currentUser.uid);
                            await setDoc(userDocRef, { photoBase64: dataUrl }, { merge: true });
                        } catch (error) {
                            console.error("Error uploading profile photo:", error);
                        }
                    }
                    img.src = event.target.result;
                }
                reader.readAsDataURL(file);
            };
            
            const handlePaste = async (e) => {
                const clipboardData = e.clipboardData;
                if (!clipboardData || !clipboardData.files || clipboardData.files.length === 0) {
                return; // No files, do nothing, allow normal text paste
                }

                const files = Array.from(clipboardData.files);
                const imageFiles = files.filter(file => file.type.startsWith('image/'));

                if (imageFiles.length > 0) {
                e.preventDefault(); // Stop the default paste action (like pasting text/path)

                const newAttachments = await Promise.all(imageFiles.map(file => {
                    return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        resolve({
                        name: file.name || 'pasted-image.png', // Provide a default name
                        type: file.type,
                        preview: reader.result,
                        data: reader.result.split(',')[1] // base64 data
                        });
                    };
                    reader.readAsDataURL(file);
                    });
                }));

                setAttachments(prev => [...prev, ...newAttachments]);
                inputRef.current?.focus();
                }
            };

            const removeAttachment = (idx) => setAttachments(prev => prev.filter((_, i) => i !== idx));
            
            const handleSignOut = async () => {
                try {
                    await signOut(auth);
                    // onAuthStateChanged will handle the state cleanup
                } catch (error) {
                    console.error("Error signing out:", error);
                }
            };

            // --- REUSABLE AVATAR COMPONENT ---
            const UserAvatar = ({ size = 24, className = '' }) => {
                if (userPhoto) {
                    return <img src={userPhoto} alt="Profile" className={`rounded-full object-cover border border-white/10 ${className}`} style={{ width: size, height: size }} />;
                }
                return (
                    <div className={`rounded-full flex items-center justify-center ${className} ${isDarkMode ? 'bg-slate-800' : 'bg-slate-200'}`} style={{ width: size, height: size }}>
                        <User size={size * 0.6} className={`${isDarkMode ? 'text-indigo-400' : 'text-indigo-600'}`} />
                    </div>
                );
            };

            // Updated Suggestion Cards
            const suggestionCards = [
                { icon: Asterisk, title: 'Algebra', prompt: 'Solve 3x² - 12x = 0', color: 'from-blue-500 to-cyan-500' },
                { icon: Triangle, title: 'Geometry', prompt: 'Calculate area of a circle with radius 5', color: 'from-emerald-500 to-teal-500' },
                { icon: Sigma, title: 'Calculus', prompt: 'Find the derivative of f(x) = x² + 4x', color: 'from-orange-500 to-amber-500' },
                { icon: Variable, title: 'Physics', prompt: 'Explain Newton\'s second law with example', color: 'from-pink-500 to-rose-500' },
            ];

            const isSendDisabled = (!inputValue.trim() && attachments.length === 0) || loadingState !== 'idle';
            
            // Loading Screen
            if (isAuthLoading) {
                return (
                    <div className={`flex h-screen w-full items-center justify-center ${isDarkMode ? 'bg-slate-950' : 'bg-slate-50'}`}>
                        <div className="animate-float">
                            <MathSolverAILogo size={100} />
                        </div>
                    </div>
                );
            }
            
            // Auth Screen
            if (!currentUser) {
                return <AuthModal isDarkMode={isDarkMode} />;
            }

            // Main App Screen
            return (
                <div className={`flex h-screen font-inter overflow-hidden transition-colors duration-500 ${isDarkMode ? 'bg-slate-950 text-slate-200' : 'bg-slate-50 text-slate-800'}`}>
                <ConfirmModal 
                    isOpen={confirmModal.isOpen} 
                    title={confirmModal.type === 'all' ? 'Delete All Chats?' : 'Delete Chat?'} 
                    message={confirmModal.type === 'all' ? 'This action cannot be undone. All your conversation history will be permanently erased.' : 'Are you sure you want to delete this chat conversation?'} 
                    onConfirm={confirmAction} 
                    onCancel={() => setConfirmModal({ isOpen: false, type: null, id: null })} 
                    isDarkMode={isDarkMode}
                />

                {/* Advanced Settings Modal */}
                {showSettings && (
                    <div className="fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center p-4 animate-fade-in">
                    <div className={`rounded-3xl w-full max-w-md shadow-2xl flex flex-col max-h-[90vh] glass-panel overflow-hidden animate-scale-in`}>
                        
                        {/* --- NEW PROFILE HEADER SECTION IN SETTINGS --- */}
                        <div className={`p-6 border-b ${isDarkMode ? 'border-white/10 bg-slate-900/50' : 'border-black/5 bg-white/50'}`}>
                            <div className="flex items-center gap-4">
                                <div className="relative group cursor-pointer">
                                    <div className="w-16 h-16 rounded-full bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 p-[2px] shadow-lg animate-pulse-glow">
                                        <div className={`w-full h-full rounded-full flex items-center justify-center overflow-hidden ${isDarkMode ? 'bg-slate-900' : 'bg-white'}`}>
                                            <UserAvatar size={64} className="w-full h-full" />
                                        </div>
                                    </div>
                                    <div className="absolute bottom-0 right-0 w-6 h-6 rounded-full bg-indigo-600 border-2 border-white dark:border-slate-900 flex items-center justify-center text-white shadow-sm hover:scale-110 transition-transform" onClick={() => profilePhotoInputRef.current?.click()}>
                                        <Camera size={12} />
                                    </div>
                                    <input 
                                        type="file" 
                                        ref={profilePhotoInputRef} 
                                        onChange={handleProfilePhotoUpload} 
                                        accept="image/*" 
                                        className="hidden" 
                                    />
                                </div>
                                <div>
                                    <h2 className={`text-xl font-bold font-display ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>
                                        {currentUser.displayName || 'User'}
                                    </h2>
                                    <p className={`text-sm ${isDarkMode ? 'text-slate-400' : 'text-slate-500'}`}>
                                        {currentUser.email}
                                    </p>
                                    <span className="inline-flex items-center gap-1 mt-1 px-2 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wider bg-indigo-500/10 text-indigo-500 border border-indigo-500/20">
                                        Pro Plan
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div className={`flex items-center justify-between p-5 border-b ${isDarkMode ? 'border-white/10' : 'border-black/5'}`}>
                        <h2 className={`text-xl font-bold flex items-center gap-2 font-display ${isDarkMode ? 'text-slate-100' : 'text-slate-800'}`}>
                            <Settings size={22} className="text-indigo-500" />
                            Settings
                        </h2>
                        <button onClick={toggleSettings} className={`p-2 rounded-full transition-all duration-300 hover:rotate-90 ${isDarkMode ? 'hover:bg-white/10 text-slate-400' : 'hover:bg-black/5 text-slate-500'}`}><X size={20} /></button>
                        </div>
                        <div className="p-5 space-y-6 overflow-y-auto custom-scrollbar">
                        
                        {/* API Configuration */}
                        <div>
                            <h3 className={`text-xs font-bold uppercase tracking-wider mb-3 ml-1 ${isDarkMode ? 'text-slate-500' : 'text-slate-400'}`}>API Configuration</h3>
                            <div className={`p-4 rounded-2xl border transition-all ${isDarkMode ? 'bg-white/5 border-white/5' : 'bg-black/5 border-black/5'}`}>
                                <div className="mb-3">
                                    <label className={`block text-xs font-semibold mb-2 ${isDarkMode ? 'text-slate-300' : 'text-slate-700'}`}>Gemini API Key</label>
                                    <div className="flex gap-2">
                                        <div className="relative flex-1">
                                            <Key size={14} className={`absolute left-3 top-1/2 -translate-y-1/2 ${isDarkMode ? 'text-slate-500' : 'text-slate-400'}`} />
                                            <input 
                                                type="password" 
                                                value={tempApiKey} 
                                                onChange={(e) => setTempApiKey(e.target.value)}
                                                placeholder="Enter your API Key"
                                                className={`w-full pl-9 pr-3 py-2 rounded-xl text-sm outline-none transition-all ${isDarkMode ? 'bg-slate-800 text-white border-slate-700 focus:border-indigo-500 placeholder-slate-600' : 'bg-white text-slate-900 border-gray-200 focus:border-indigo-500 placeholder-slate-400'} border`}
                                            />
                                        </div>
                                        <button 
                                            onClick={() => validateApiKey(tempApiKey)}
                                            disabled={apiStatus === 'validating' || !tempApiKey}
                                            className={`px-4 py-2 rounded-xl text-sm font-bold text-white transition-all shadow-lg active:scale-95 disabled:opacity-70 disabled:cursor-not-allowed ${apiStatus === 'validating' ? 'bg-slate-500' : 'bg-indigo-600 hover:bg-indigo-500 shadow-indigo-500/20'}`}
                                        >
                                            {apiStatus === 'validating' ? 'Checking...' : 'Connect'}
                                        </button>
                                    </div>
                                </div>
                                
                                {/* Status Indicator */}
                                <div className="flex items-center gap-2 text-xs">
                                    <span className={`font-semibold ${isDarkMode ? 'text-slate-500' : 'text-slate-400'}`}>Status:</span>
                                    {apiStatus === 'valid' ? (
                                        <span className="flex items-center gap-1 text-emerald-500 font-bold bg-emerald-500/10 px-2 py-0.5 rounded-full border border-emerald-500/20 animate-fade-in"><Check size={12} strokeWidth={3} /> Connected</span>
                                    ) : apiStatus === 'invalid' ? (
                                        <span className="flex items-center gap-1 text-red-500 font-bold bg-red-500/10 px-2 py-0.5 rounded-full border border-red-500/20 animate-fade-in"><AlertTriangle size={12} strokeWidth={3} /> Invalid API Key</span>
                                    ) : (
                                        <span className={`${isDarkMode ? 'text-slate-500' : 'text-slate-400'}`}>Not Connected (Using Default if available)</span>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Appearance */}
                        <div>
                            <h3 className={`text-xs font-bold uppercase tracking-wider mb-3 ml-1 ${isDarkMode ? 'text-slate-500' : 'text-slate-400'}`}>Appearance</h3>
                            {/* ADVANCED THEME TOGGLE */}
                            <div className={`flex items-center justify-between p-4 rounded-2xl border transition-all ${isDarkMode ? 'bg-white/5 border-white/5 hover:border-indigo-500/30' : 'bg-black/5 border-black/5 hover:border-indigo-500/30'}`}>
                                <div className="flex items-center gap-3">
                                <div className={`p-2.5 rounded-xl ${isDarkMode ? 'bg-indigo-500/20 text-indigo-300' : 'bg-indigo-100 text-indigo-600'}`}>
                                    {isDarkMode ? <Moon size={20} /> : <Sun size={20} />}
                                </div>
                                <div>
                                    <p className={`font-semibold ${isDarkMode ? 'text-slate-200' : 'text-slate-800'}`}>Theme</p>
                                    <p className={`text-xs ${isDarkMode ? 'text-slate-400' : 'text-slate-500'}`}>{isDarkMode ? 'Dark Mode' : 'Light Mode'}</p>
                                </div>
                                </div>
                                
                                <button 
                                    onClick={toggleDarkMode}
                                    className={`w-16 h-9 rounded-full relative transition-all duration-300 ease-in-out focus:outline-none focus:ring-4 focus:ring-indigo-500/20 ${isDarkMode ? 'bg-slate-700' : 'bg-slate-200'}`}
                                >
                                    <span className={`absolute top-1 left-1 bg-white w-7 h-7 rounded-full shadow-md transform transition-transform duration-300 flex items-center justify-center ${isDarkMode ? 'translate-x-7' : 'translate-x-0'}`}>
                                        {isDarkMode ? <Moon size={14} className="text-indigo-600" /> : <Sun size={14} className="text-amber-500" />}
                                    </span>
                                </button>
                            </div>
                        </div>

                        {/* Data */}
                        <div>
                            <h3 className={`text-xs font-bold uppercase tracking-wider mb-3 ml-1 ${isDarkMode ? 'text-slate-500' : 'text-slate-400'}`}>Data Management</h3>
                            
                            {/* Clear History */}
                            <button onClick={initiateClearAllChats} className={`w-full group flex items-center justify-between p-4 rounded-2xl transition-all cursor-pointer border mb-3 active:scale-95 ${isDarkMode ? 'bg-white/5 border-white/5 text-slate-300 hover:bg-red-500/10 hover:text-red-400 hover:border-red-500/30' : 'bg-black/5 border-black/5 text-slate-700 hover:bg-red-50 hover:text-red-600 hover:border-red-300'}`}>
                                <div className="flex items-center gap-3">
                                    <div className={`p-2 rounded-lg transition-colors ${isDarkMode ? 'bg-white/5 group-hover:bg-red-500/20' : 'bg-white shadow-sm group-hover:bg-red-100'}`}><Trash2 size={18} /></div>
                                    <span className="font-semibold">Clear All Chats</span>
                                </div>
                                <ChevronRight size={16} className="opacity-50" />
                            </button>
                            
                            {/* Sign Out */}
                            <button onClick={handleSignOut} className={`w-full group flex items-center justify-between p-4 rounded-2xl transition-all cursor-pointer border active:scale-95 ${isDarkMode ? 'bg-white/5 border-white/5 text-slate-300 hover:bg-white/10' : 'bg-black/5 border-black/5 text-slate-700 hover:bg-black/10'}`}>
                                <div className="flex items-center gap-3">
                                    <div className={`p-2 rounded-lg ${isDarkMode ? 'bg-white/5' : 'bg-white shadow-sm'}`}><LogOut size={18} /></div>
                                    <span className="font-semibold">Sign Out</span>
                                </div>
                                <ChevronRight size={16} className="opacity-50" />
                            </button>
                        </div>

                        </div>
                        <div className={`p-4 text-center text-xs font-medium border-t ${isDarkMode ? 'border-white/10 text-slate-500' : 'border-black/5 text-slate-400'}`}>Version 4.0.0 Pro • Crafted by Md. Amzad Hossain Sadik</div>
                    </div>
                    </div>
                )}

                {/* Sidebar (Mobile Responsive) */}
                <div className={`fixed inset-y-0 left-0 z-30 transform transition-all duration-300 ease-in-out ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0 ${isSidebarOpen ? 'w-80 md:w-80' : 'w-80 md:w-0 md:overflow-hidden'} ${isDarkMode ? 'bg-slate-900/50 backdrop-blur-xl border-r border-white/5' : 'bg-white/80 backdrop-blur-xl border-r border-black/5'} flex flex-col flex-shrink-0 shadow-2xl md:shadow-none`}>
                    <div className="p-6 flex items-center justify-between">
                    <div className={`flex items-center gap-3 group cursor-pointer`}>
                        <div className="relative w-10 h-10 transition-transform duration-300 group-hover:scale-110">
                            <MathSolverAILogo size={40} />
                        </div>
                        <div className={`${!isSidebarOpen && 'md:hidden'}`}>
                            <h1 className={`font-bold font-display text-lg leading-tight ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>Math Solver</h1>
                            <span className="text-[10px] font-bold uppercase tracking-wider text-indigo-500 bg-indigo-500/10 px-2 py-0.5 rounded-full border border-indigo-500/20">Pro</span>
                        </div>
                    </div>
                    {/* Close button for mobile sidebar */}
                    <button onClick={toggleSidebar} className={`md:hidden p-2 rounded-full transition-colors ${isDarkMode ? 'text-slate-400 hover:bg-white/10 hover:text-white' : 'text-slate-600 hover:bg-black/5 hover:text-black'}`}><X size={20} /></button>
                    </div>
                    <div className="px-4 pb-6">
                        <button onClick={startNewChat} className="w-full flex items-center justify-center gap-2 px-4 py-3.5 bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 text-white hover:from-indigo-500 hover:via-purple-500 hover:to-pink-500 rounded-2xl transition-all duration-300 font-semibold shadow-lg shadow-indigo-500/25 hover:shadow-indigo-500/40 active:scale-[0.98] group">
                            <Plus className="w-5 h-5 md:w-6 md:h-6 transition-transform group-hover:rotate-90" strokeWidth={2.5} /> 
                            <span className={`${!isSidebarOpen && 'md:hidden'}`}>New Chat</span>
                        </button>
                    </div>
                    <div className="flex-1 overflow-y-auto px-4 py-2 custom-scrollbar">
                    <div className={`flex items-center justify-between text-xs font-bold mb-4 px-2 uppercase tracking-wider ${isDarkMode ? 'text-slate-500' : 'text-slate-400'}`}>
                        <div className="flex items-center gap-2"><History size={14} /> <span className={`${!isSidebarOpen && 'md:hidden'}`}>Recent History</span></div>
                        {messages.length > 0 && <button onClick={(e) => {e.stopPropagation(); setConfirmModal({isOpen: true, type: 'current', id: currentChatId})}} className="hover:text-red-500 transition-colors flex items-center gap-1 p-1 rounded-md hover:bg-red-500/10" title="Clear current chat"><Trash2 size={14}/></button>}
                    </div>
                    <div className="space-y-2">
                        {recentChats.map(chat => (
                        <div key={chat.id} onClick={() => loadChat(chat.id)} className={`group flex items-center justify-between px-3.5 py-3 rounded-xl cursor-pointer transition-all duration-200 border ${currentChatId === chat.id ? (isDarkMode ? 'bg-indigo-500/10 text-indigo-300 border-indigo-500/20' : 'bg-indigo-50 text-indigo-700 border-indigo-100') : (isDarkMode ? 'border-transparent text-slate-400 hover:bg-white/5 hover:text-slate-200 hover:border-white/5' : 'border-transparent text-slate-600 hover:bg-black/5 hover:text-slate-900 hover:border-black/5')}`}>
                            <div className="flex items-center gap-3 overflow-hidden">
                                <div className={`p-1.5 rounded-lg ${currentChatId === chat.id ? 'bg-indigo-500/20' : 'bg-transparent group-hover:bg-slate-500/10'}`}>
                                    <MessageSquare size={16} className={currentChatId === chat.id ? 'text-indigo-500' : 'opacity-70'} />
                                </div>
                                <span className="truncate text-sm font-medium">{chat.title || 'New Chat'}</span>
                            </div>
                            <button 
                            onClick={(e) => initiateDeleteChat(e, chat.id)} 
                            className={`p-1.5 rounded-lg transition-all opacity-0 group-hover:opacity-100 focus:opacity-100 ${isDarkMode ? 'hover:bg-red-500/20 hover:text-red-400 text-slate-500' : 'hover:bg-red-100 hover:text-red-600 text-slate-400'}`}
                            title="Delete Chat"
                            >
                                <Trash2 size={14} />
                            </button>
                        </div>
                        ))}
                    </div>
                    </div>
                    <div className={`p-4 border-t ${isDarkMode ? 'border-white/5' : 'border-black/5'}`}>
                    <button onClick={toggleSettings} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 font-medium active:scale-95 relative ${isDarkMode ? 'text-slate-400 hover:text-slate-200 hover:bg-white/5' : 'text-slate-600 hover:text-slate-900 hover:bg-black/5'}`}>
                        <Settings size={20} /> <span className={`${!isSidebarOpen && 'md:hidden'}`}>Settings</span>
                        {apiStatus !== 'valid' && <span className="absolute top-3 left-7 w-2.5 h-2.5 bg-red-500 border-2 border-white dark:border-slate-900 rounded-full"></span>}
                    </button>
                    </div>
                </div>

                {/* Overlay for mobile sidebar */}
                {isSidebarOpen && (
                    <div className="fixed inset-0 bg-black/60 z-20 md:hidden backdrop-blur-sm" onClick={toggleSidebar}></div>
                )}

                {/* Main Content */}
                <div className={`flex-1 flex flex-col relative min-w-0 ${isDarkMode ? 'bg-slate-950' : 'bg-gray-50'}`}>
                    <header className={`h-16 md:h-20 flex items-center px-4 md:px-6 relative z-10 justify-between backdrop-blur-md sticky top-0 border-b ${isDarkMode ? 'bg-slate-950/80 border-white/5' : 'bg-white/80 border-black/5'}`}>
                    <div className="flex items-center">
                        <button onClick={toggleSidebar} className={`p-2 rounded-xl transition-all mr-3 active:scale-95 ${isDarkMode ? 'hover:bg-white/10 text-slate-400 hover:text-white' : 'hover:bg-black/5 text-slate-600 hover:text-black'}`}><Menu size={24} /></button>
                        <div className={`flex items-center gap-3 font-bold text-lg md:text-xl font-display ${isDarkMode ? 'text-slate-100' : 'text-slate-800'}`}>
                            <span className="md:hidden"><MathSolverAILogo size={32} /></span>
                            <span className={`hidden md:inline md:transition-all md:duration-200 ${!isSidebarOpen ? 'opacity-100 translate-x-0' : 'opacity-0 -translate-x-4 pointer-events-none'}`}><MathSolverAILogo size={36} /> Math Solver</span>
                            <span className="md:hidden">Math Solver</span>
                        </div>
                    </div>
                    <div className="flex items-center gap-2">
                        <button onClick={handleShare} className={`p-2 rounded-full transition-colors hidden md:block active:scale-95 ${isDarkMode ? 'hover:bg-white/10 text-slate-400 hover:text-white' : 'hover:bg-black/5 text-slate-600 hover:text-black'}`} title="Share">
                            <Share2 size={20} />
                        </button>
                        <div className={`w-8 h-8 md:w-10 md:h-10 rounded-full bg-gradient-to-br from-indigo-500 to-pink-500 p-[2px] cursor-pointer`}>
                             <div className={`w-full h-full rounded-full flex items-center justify-center overflow-hidden ${isDarkMode ? 'bg-slate-900' : 'bg-white'}`}>
                                <UserAvatar size={36} />
                             </div>
                        </div>
                    </div>
                    </header>

                    {/* Main chat area */}
                    <main className={`flex-1 relative flex flex-col overflow-y-auto custom-scrollbar px-4`}>
                    {showLanding ? (
                        <div className="flex-1 min-h-full flex flex-col items-center justify-center p-6 md:p-12 text-center animate-fade-in relative">
                        {/* Background Decor */}
                        <div className={`absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[500px] h-[500px] bg-gradient-to-r from-indigo-500/20 via-purple-500/20 to-pink-500/20 rounded-full blur-[100px] pointer-events-none ${isDarkMode ? 'opacity-30' : 'opacity-60'}`}></div>
                        
                        <div className="relative mb-8 scale-110 md:scale-125 transition-transform hover:scale-150 duration-700 cursor-pointer">
                            <MathSolverAILogo size={120} />
                        </div>
                        <h1 className={`text-4xl md:text-6xl font-extrabold mb-6 tracking-tight font-display bg-clip-text text-transparent bg-gradient-to-r ${isDarkMode ? 'from-white via-indigo-200 to-pink-300' : 'from-slate-900 via-indigo-800 to-pink-600'}`}>
                            Master Math & Creativity
                        </h1>
                        <p className={`max-w-xl text-lg md:text-xl mb-10 leading-relaxed font-medium ${isDarkMode ? 'text-slate-400' : 'text-slate-600'}`}>
                            Solve complex problems, visualize geometry, or generate images directly with our advanced AI.
                        </p>
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 max-w-4xl w-full">
                            {suggestionCards.map((card, index) => (
                            <button key={index} onClick={() => handleSendMessage(card.prompt)} className={`text-left p-5 border rounded-2xl transition-all duration-300 group relative overflow-hidden hover:shadow-2xl hover:-translate-y-1 active:scale-[0.98] ${isDarkMode ? 'bg-slate-900/40 hover:bg-slate-800/60 border-white/5 backdrop-blur-sm' : 'bg-white hover:bg-white border-black/5 hover:border-indigo-500/30'}`}>
                                <div className={`absolute inset-0 bg-gradient-to-r ${card.color} opacity-0 group-hover:opacity-5 transition-opacity duration-500`}></div>
                                <div className="flex items-start gap-5 relative z-10">
                                    <div className={`p-3 rounded-2xl bg-gradient-to-br ${card.color} text-white shadow-lg group-hover:scale-110 transition-transform duration-300`}>
                                        <card.icon className="w-6 h-6" strokeWidth={2.5} />
                                    </div>
                                    <div>
                                        <h3 className={`font-bold text-lg mb-1 font-display ${isDarkMode ? 'text-slate-200 group-hover:text-white' : 'text-slate-800 group-hover:text-indigo-900'}`}>{card.title}</h3>
                                        <p className={`text-sm font-medium leading-snug ${isDarkMode ? 'text-slate-400 group-hover:text-slate-300' : 'text-slate-500 group-hover:text-slate-700'}`}>{card.prompt}</p>
                                    </div>
                                </div>
                            </button>
                            ))}
                        </div>
                        </div>
                    ) : (
                        <div className="flex-1 py-6 md:py-10 flex flex-col gap-8 max-w-4xl mx-auto w-full">
                        {messages.map((msg, idx) => (
                            <div key={idx} className={`flex gap-4 md:gap-6 ${msg.role === 'user' ? 'justify-end' : ''} animate-slide-up`}>
                            {msg.role === 'model' && <div className={`w-10 h-10 flex-shrink-0 rounded-full flex items-center justify-center shadow-lg overflow-hidden ${isDarkMode ? 'bg-slate-900 border border-white/10' : 'bg-white border border-black/5'}`}><MathSolverAILogo size={40} /></div>}
                            <div className={`max-w-[85%] ${msg.role === 'user' ? 'order-first' : ''}`}>
                                <div className={`px-5 py-3 md:px-6 md:py-4 w-fit rounded-[2rem] shadow-sm relative overflow-hidden ${msg.role === 'user' ? (isDarkMode ? 'bg-gradient-to-br from-indigo-600 to-purple-600 text-white rounded-br-none shadow-indigo-500/20 ml-auto' : 'bg-gradient-to-br from-indigo-600 to-purple-600 text-white rounded-br-none shadow-indigo-500/20 ml-auto') : (isDarkMode ? 'bg-slate-900/80 text-slate-200 border border-white/5 rounded-bl-none' : 'bg-white text-slate-800 border border-gray-100 shadow-sm rounded-bl-none')}`}>
                                    <MarkdownRenderer content={msg.content} isDarkMode={isDarkMode} fontSize={fontSize} isUserMessage={msg.role === 'user'} />
                                    {msg.isImage && msg.role === 'model' && (
                                        <div className="mt-4 flex justify-end">
                                            <button onClick={() => handleDownloadImage(msg.content)} className={`flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-semibold transition-colors active:scale-95 shadow-sm ${isDarkMode ? 'bg-white/10 hover:bg-white/20 text-white' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'}`}>
                                                <Download size={16} /> Download Image
                                            </button>
                                        </div>
                                    )}
                                    {msg.attachments?.length > 0 && (
                                        <div className="mt-4 flex flex-wrap gap-3">
                                            {msg.attachments.map((att, i) => (
                                                <div key={i} className={`overflow-hidden rounded-2xl border ${isDarkMode ? 'border-white/10 bg-black/20' : 'border-black/5 bg-white/50'} max-w-[200px] transition-transform hover:scale-105 shadow-sm`}>
                                                    {att.preview ? <img src={att.preview} alt="attachment" className="max-h-32 w-auto object-cover" /> : <div className="flex items-center gap-3 p-3"><div className={`p-2.5 rounded-xl ${isDarkMode ? 'bg-indigo-500/20 text-indigo-400' : 'bg-indigo-50 text-indigo-600'}`}><FileText className="w-5 h-5" /></div><span className={`text-xs font-semibold truncate ${isDarkMode ? 'text-slate-200' : 'text-slate-700'}`}>{att.name}</span></div>}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                {msg.role === 'model' && !msg.isImage && (
                                    <div className="flex flex-col gap-3 mt-3 ml-4">
                                    {idx === messages.length - 1 && loadingState === 'idle' && (
                                        <div className="flex items-center gap-2 animate-fade-in flex-wrap">
                                        <button onClick={() => handleAIAction('practice')} className={`flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold transition-all border shadow-sm active:scale-95 ${isDarkMode ? 'bg-slate-800 border-slate-700 hover:bg-slate-700 text-indigo-400' : 'bg-white border-slate-200 hover:bg-indigo-50 text-indigo-600'}`}><Sparkles size={14} /> Practice Problem</button>
                                        <button onClick={() => handleAIAction('simplify')} className={`flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold transition-all border shadow-sm active:scale-95 ${isDarkMode ? 'bg-slate-800 border-slate-700 hover:bg-slate-700 text-indigo-400' : 'bg-white border-slate-200 hover:bg-indigo-50 text-indigo-600'}`}><Lightbulb size={14} /> Simplify Explanation</button>
                                        </div>
                                    )}
                                    <div className="flex items-center gap-4 opacity-100 transition-opacity duration-300">
                                        <div className={`flex items-center gap-1 p-1 rounded-full ${isDarkMode ? 'bg-slate-900/50' : 'bg-gray-100'}`}>
                                            <button onClick={() => handleFeedback(idx, 'up')} className={`p-1.5 rounded-full transition-colors active:scale-90 ${feedbacks[idx] === 'up' ? 'text-green-500 bg-green-500/10' : (isDarkMode ? 'hover:bg-slate-800 text-slate-400' : 'hover:bg-white text-slate-500')}`}><ThumbsUp className="w-4 h-4" /></button>
                                            <div className={`w-px h-3 ${isDarkMode ? 'bg-slate-700' : 'bg-gray-300'}`}></div>
                                            <button onClick={() => handleFeedback(idx, 'down')} className={`p-1.5 rounded-full transition-colors active:scale-90 ${feedbacks[idx] === 'down' ? 'text-red-500 bg-red-500/10' : (isDarkMode ? 'hover:bg-slate-800 text-slate-400' : 'hover:bg-white text-slate-500')}`}><ThumbsDown className="w-4 h-4" /></button>
                                        </div>
                                        <button onClick={() => handleCopy(msg.content, idx)} className={`flex items-center gap-1.5 text-xs font-medium transition-colors ${isDarkMode ? 'text-slate-400 hover:text-slate-200' : 'text-slate-500 hover:text-slate-800'}`}>{copiedMessageId === idx ? <><Check className="text-green-500 w-3.5 h-3.5" /> Copied</> : <><Copy className="w-3.5 h-3.5" /> Copy</>}</button>
                                        {idx === messages.length - 1 && loadingState === 'idle' && <button onClick={() => handleSendMessage(null, true)} className={`flex items-center gap-1.5 text-xs font-medium transition-colors ${isDarkMode ? 'text-slate-400 hover:text-slate-200' : 'text-slate-500 hover:text-slate-800'}`}><RefreshCw className="w-3.5 h-3.5" /> Regenerate</button>}
                                    </div>
                                    </div>
                                )}
                            </div>
                                {msg.role === 'user' && <div className={`w-10 h-10 flex-shrink-0 rounded-full flex items-center justify-center mt-1 shadow-md overflow-hidden ${isDarkMode ? 'bg-slate-800 text-slate-300' : 'bg-gradient-to-br from-gray-100 to-gray-200 text-slate-600'}`}><UserAvatar size={40} /></div>}
                            </div>
                        ))}
                        
                        {loadingState !== 'idle' && (
                            <div className="flex gap-4 md:gap-6 animate-slide-up">
                            <div className={`w-10 h-10 flex-shrink-0 rounded-full flex items-center justify-center shadow-lg overflow-hidden animate-pulse ${isDarkMode ? 'bg-slate-900 border border-white/10' : 'bg-white border border-black/5'}`}>
                                <MathSolverAILogo size={40} />
                            </div>
                            <div className={`px-6 py-5 rounded-[2rem] rounded-bl-none border flex items-center gap-4 ${isDarkMode ? 'bg-slate-900 border-white/5' : 'bg-white border-gray-100 shadow-sm'}`}>
                            <div className="flex items-center space-x-1.5">
                                <div className="w-2.5 h-2.5 bg-indigo-500 rounded-full animate-[bounce_1s_infinite_0ms]"></div>
                                <div className="w-2.5 h-2.5 bg-purple-500 rounded-full animate-[bounce_1s_infinite_200ms]"></div>
                                <div className="w-2.5 h-2.5 bg-pink-500 rounded-full animate-[bounce_1s_infinite_400ms]"></div>
                            </div>
                            <span className={`font-semibold text-sm bg-clip-text text-transparent bg-gradient-to-r from-indigo-500 to-pink-500 animate-pulse`}>
                                {loadingState === 'drawing' ? 'Generating visual masterpiece...' : (loadingState === 'reading' ? 'Analyzing documents...' : 'Solving complex problem...')}
                            </span>
                            </div>
                            </div>
                        )}
                        <div ref={messagesEndRef} className="h-6" />
                        </div>
                    )}
                    </main>

                    <div className={`p-4 pb-6 relative z-20`}>
                        <div className="max-w-3xl mx-auto relative">
                        {/* Gradient Fade for Scroll */}
                        <div className={`absolute inset-x-0 bottom-full h-32 bg-gradient-to-t pointer-events-none ${isDarkMode ? 'from-slate-950 via-slate-950/80' : 'from-slate-50 via-slate-50/80'} to-transparent`} />
                        
                        <div className={`rounded-[2rem] shadow-2xl transition-all duration-300 overflow-hidden ring-1 ${isDarkMode ? 'bg-slate-900/80 ring-white/10 shadow-indigo-500/10' : 'bg-white ring-black/5 shadow-xl'}`}>
                            {attachments.length > 0 && (
                                    <div className={`p-4 flex flex-wrap gap-3 relative animate-fade-in ${isDarkMode ? 'bg-slate-900/50' : 'bg-slate-50/50'}`}>
                                    {attachments.map((att, index) => (
                                        <div key={index} className="relative group animate-scale-in">
                                            {att.preview ? <div className="w-16 h-16 md:w-20 md:h-20 rounded-2xl border-2 border-indigo-500/30 overflow-hidden shadow-sm"><img src={att.preview} alt="preview" className="w-full h-full object-cover" /></div> : <div className={`w-16 h-16 md:w-20 md:h-20 rounded-2xl flex items-center justify-center shadow-sm border-2 border-indigo-500/30 ${isDarkMode ? 'bg-slate-800 text-indigo-400' : 'bg-white text-indigo-500'}`}><FileText className="w-8 h-8" strokeWidth={1.5} /></div>}
                                            <button onClick={() => removeAttachment(index)} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow-lg opacity-0 group-hover:opacity-100 transition-all hover:scale-110"><X className="w-3.5 h-3.5" strokeWidth={3} /></button>
                                        </div>
                                    ))}
                                    </div>
                            )}
                            {attachments.length > 0 && <div className={`h-px w-full ${isDarkMode ? 'bg-white/10' : 'bg-black/5'}`} />}
                            
                            <div className="flex items-end p-2 pl-4">
                            <input type="file" multiple ref={fileInputRef} onChange={handleFileChange} className="hidden" />
                            
                            <button onClick={() => fileInputRef.current?.click()} className={`p-3 mb-1 rounded-full transition-all active:scale-90 group ${isDarkMode ? 'text-slate-400 hover:bg-indigo-500/20 hover:text-indigo-400' : 'text-slate-400 hover:bg-indigo-50 hover:text-indigo-600'}`} title="Add attachments">
                                <Plus className="w-6 h-6 transition-transform group-hover:rotate-90" strokeWidth={2.5} />
                            </button>
                            
                            <textarea 
                                ref={inputRef} 
                                value={inputValue} 
                                onChange={handleInputChange} 
                                onKeyDown={handleKeyDown} 
                                onPaste={handlePaste}
                                placeholder="Ask math problems..." 
                                rows={1} 
                                className={`flex-1 bg-transparent outline-none py-4 px-4 text-[16px] font-medium resize-none max-h-[200px] overflow-y-auto custom-scrollbar min-h-[56px] ${isDarkMode ? 'text-slate-200 placeholder-slate-500' : 'text-slate-800 placeholder-slate-400'}`} 
                            />
                            
                            <button onClick={() => handleSendMessage()} disabled={isSendDisabled} className={`w-12 h-12 mb-1 mr-1 rounded-full flex items-center justify-center transition-all duration-300 shadow-lg ${isSendDisabled ? (isDarkMode ? 'bg-slate-800 text-slate-600 cursor-not-allowed' : 'bg-slate-200 text-slate-400 cursor-not-allowed') : 'bg-gradient-to-r from-indigo-600 to-pink-600 hover:from-indigo-500 hover:to-pink-500 text-white hover:scale-105 active:scale-95 hover:shadow-indigo-500/25'}`}>
                                <Send className={`${(inputValue.trim() || attachments.length > 0) ? '-ml-0.5' : ''} w-5 h-5`} strokeWidth={3} />
                            </button>
                            </div>
                        </div>
                        <div className={`text-center mt-3 text-[10px] font-medium ${isDarkMode ? 'text-slate-600' : 'text-slate-400'}`}>
                            Math Solver AI can make mistakes. Double check important calculations.
                        </div>
                        </div>
                    </div>
                </div>
                </div>
            );
        }

        const style = document.createElement('style');
        style.textContent = `
        .font-inter { font-family: 'Inter', sans-serif; }
        .font-display { font-family: 'Lexend', sans-serif; }
        
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        @keyframes scale-in { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .animate-scale-in { animation: scale-in 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }

        @keyframes slide-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-up { animation: slide-up 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        @keyframes pulse-slow { 0%, 100% { opacity: 0.8; transform: scale(1); } 50% { opacity: 1; transform: scale(1.05); } }
        .animate-pulse-slow { animation: pulse-slow 4s ease-in-out infinite; }
        
        /* Bounce animation for loading dots */
        @keyframes bounce { 
            0%, 80%, 100% { transform: scale(0); opacity: 0; } 
            40% { transform: scale(1.0); opacity: 1; } 
        }
        .animate-bounce { animation-name: bounce; animation-duration: 1.4s; animation-iteration-count: infinite; animation-timing-function: ease-in-out; }
        `;
        document.head.appendChild(style);

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>