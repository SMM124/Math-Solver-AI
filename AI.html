<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Math Solver AI</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%234F46E5'/%3E%3Cstop offset='50%25' stop-color='%238B5CF6'/%3E%3Cstop offset='100%25' stop-color='%23EC4899'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath d='M25,50 C25,30 40,30 50,50 C60,70 75,70 75,50 C75,30 60,30 50,50 C40,70 25,70 25,50 Z' fill='none' stroke='url(%23g)' stroke-width='10' stroke-linecap='round'/%3E%3C/svg%3E" type="image/svg+xml">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                        display: ['Lexend', 'sans-serif'],
                    },
                    animation: {
                        'spin-slow': 'spin 8s linear infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-glow': 'pulse-glow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'slide-up-fade': 'slideUpFade 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                        'slide-up-menu': 'slideUpMenu 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                        'scale-in': 'scaleIn 0.2s ease-out',
                        'fade-in': 'fadeIn 0.2s ease-out',
                        'typing': 'typing 1s steps(20, end)',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        'pulse-glow': {
                            '0%, 100%': { opacity: 1, boxShadow: '0 0 20px rgba(99, 102, 241, 0.5)' },
                            '50%': { opacity: .7, boxShadow: '0 0 10px rgba(99, 102, 241, 0.2)' },
                        },
                        slideUpFade: {
                            '0%': { opacity: 0, transform: 'translateY(10px)' },
                            '100%': { opacity: 1, transform: 'translateY(0)' },
                        },
                        slideUpMenu: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        },
                        scaleIn: {
                            '0%': { transform: 'scale(0.95)', opacity: 0 },
                            '100%': { transform: 'scale(1)', opacity: 1 },
                        },
                        fadeIn: {
                            '0%': { opacity: 0 },
                            '100%': { opacity: 1 },
                        }
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.37)',
                        'neon': '0 0 10px rgba(99, 102, 241, 0.5), 0 0 20px rgba(99, 102, 241, 0.3)',
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Lexend:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

    <!-- Import Maps -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client?deps=react@18.2.0",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0?deps=react@18.2.0",
            "react-markdown": "https://esm.sh/react-markdown@9.0.1?deps=react@18.2.0",
            "katex": "https://esm.sh/katex@0.16.9",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
        }
    }
    </script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .dark .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glass-button {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s ease;
        }
        .glass-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        .custom-scrollbar::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: rgba(156, 163, 175, 0.5); border-radius: 20px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background-color: rgba(75, 85, 99, 0.5); }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: rgba(107, 114, 128, 0.8); }
        
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-gray-50 dark:bg-slate-950 transition-colors duration-500">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useRef, useEffect, useCallback } from 'react';
        import ReactDOM from 'react-dom/client';
        import { Menu, Plus, Settings, Send, X, Sparkles, Lightbulb, Trash2, ThumbsUp, ThumbsDown, Copy, Check, FileText, Globe, RefreshCw, Download, User, Moon, Sun, History, Asterisk, Triangle, Sigma, Variable, Share2, LogOut, Eye, EyeOff, Type, Languages, AlertTriangle, ArrowRight, Lock, Mail, ChevronRight, MessageSquare, Zap, LayoutGrid, Monitor, Camera, Edit2, Key, Image as ImageIcon, Smartphone, Paperclip, Code, HardDrive, LayoutTemplate, MoreHorizontal, Pin, PenLine, Info } from 'lucide-react';
        import ReactMarkdown from 'react-markdown';
        import katex from 'katex';
        
        // Firebase Imports
        import { initializeApp } from "firebase/app";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence, updateProfile } from "firebase/auth";
        import { getFirestore, doc, addDoc, deleteDoc, onSnapshot, collection, query, arrayUnion, updateDoc, serverTimestamp, getDocs, writeBatch, setDoc, getDoc } from "firebase/firestore";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyDW4gCKg1ojKjvBwgcU3rfFNvkW6_jy-KQ",
            authDomain: "math-solv.firebaseapp.com",
            projectId: "math-solv",
            storageBucket: "math-solv.firebasestorage.app",
            messagingSenderId: "798961802726",
            appId: "1:798961802726:web:d7f12d3248522e63540a27",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Local Storage Helper ---
        const safeLocalStorage = {
            getItem: (key) => { try { return localStorage.getItem(key); } catch (e) { return null; } },
            setItem: (key, value) => { try { localStorage.setItem(key, value); } catch (e) { } },
            removeItem: (key) => { try { localStorage.removeItem(key); } catch (e) { } }
        };

        // **********************************************
        // 1. এখানে আপনার ডিফল্ট Gemini API Key দিন:
        // **********************************************
        const defaultApiKey = ""; // <-- এখানে আপনার Key দিন

        // **********************************************
        // 2. এখানে আপনার n8n Webhook URL দিন (ইমেইল পাঠানোর জন্য):
        // **********************************************
        const n8nWebhookUrl = "https://1069-319.n8n1.deltadns.xyz/webhook/send-otp"; 

        const useKatexStyles = () => { useEffect(() => { }, []); };

        const InlineMath = ({ math }) => {
            try { return <span dangerouslySetInnerHTML={{ __html: katex.renderToString(math, { throwOnError: false, displayMode: false }) }} className="inline-block" />; } 
            catch (e) { return <span className="font-mono text-red-400">{math}</span>; }
        };

        const BlockMath = ({ math }) => {
            try { return <div className="my-4 overflow-x-auto custom-scrollbar p-2 rounded-lg bg-gray-50/50 dark:bg-slate-900/50" dangerouslySetInnerHTML={{ __html: katex.renderToString(math, { throwOnError: false, displayMode: true }) }} />; } 
            catch (e) { return <div className="font-mono text-red-400 my-4">{math}</div>; }
        };

        const CodeBlock = ({ language, children, isDarkMode, isUserMessage }) => {
            const [copied, setCopied] = useState(false);
            const handleCopy = () => {
                const textArea = document.createElement("textarea");
                textArea.value = String(children).replace(/\n$/, '');
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                textArea.style.top = "0";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                } catch (err) { }
                document.body.removeChild(textArea);
            };
            return (
                <div className="my-4 rounded-xl overflow-hidden border shadow-sm transition-all duration-200 hover:shadow-md border-gray-200 dark:border-gray-700 w-full max-w-[50rem]">
                    <div className={`flex items-center justify-between px-4 py-2 border-b ${isDarkMode ? 'bg-slate-800 border-gray-700' : 'bg-gray-100 border-gray-200'}`}>
                        <span className={`text-xs font-bold uppercase font-mono tracking-wider ${isDarkMode ? 'text-gray-400' : 'text-gray-600'}`}>{language || 'Code'}</span>
                        <button onClick={handleCopy} className="flex items-center gap-1.5 text-xs font-medium text-indigo-500 hover:text-indigo-400 transition-colors focus:outline-none">
                            {copied ? <><Check size={14} className="text-emerald-500" /><span className="text-emerald-500">Copied!</span></> : <><Copy size={14} /><span>Copy</span></>}
                        </button>
                    </div>
                    <pre className={`relative m-0 p-4 overflow-x-auto custom-scrollbar max-h-[22.5rem] ${isUserMessage ? 'bg-black/20 text-white' : (isDarkMode ? 'bg-slate-900 text-indigo-300' : 'bg-gray-50 text-indigo-700')}`}>
                        <code className="text-sm font-mono leading-relaxed whitespace-pre">{children}</code>
                    </pre>
                </div>
            );
        };

        const getMarkdownComponents = (isDarkMode, isUserMessage, isError = false) => {
            const textColor = isError ? 'text-red-500 font-bold' : (isUserMessage ? 'text-white/95' : (isDarkMode ? 'text-slate-300' : 'text-slate-700'));
            const headingColor = isUserMessage ? 'text-white' : (isDarkMode ? 'text-indigo-300' : 'text-indigo-800');
            const borderColor = isUserMessage ? 'border-white/20' : (isDarkMode ? 'border-gray-700' : 'border-gray-200');

            return {
                h1: ({node, ...props}) => <h1 className={`text-2xl font-bold mt-6 mb-4 font-display border-b pb-2 ${headingColor} ${borderColor}`} {...props} />,
                h2: ({node, ...props}) => <h2 className={`text-xl font-bold mt-5 mb-3 font-display ${isUserMessage ? 'text-white' : (isDarkMode ? 'text-indigo-200' : 'text-indigo-700')}`} {...props} />,
                h3: ({node, ...props}) => <h3 className={`text-lg font-bold mt-4 mb-2 font-display ${isUserMessage ? 'text-white/90' : (isDarkMode ? 'text-indigo-100' : 'text-indigo-600')}`} {...props} />,
                p: ({node, ...props}) => <p className={`mb-3 leading-relaxed text-base ${textColor}`} {...props} />,
                strong: ({node, ...props}) => <strong className={`font-bold ${isUserMessage ? 'text-white' : (isDarkMode ? 'text-indigo-400' : 'text-indigo-700')}`} {...props} />,
                em: ({node, ...props}) => <em className={`italic ${isUserMessage ? 'text-white/80' : (isDarkMode ? 'text-purple-300' : 'text-purple-600')}`} {...props} />,
                blockquote: ({node, ...props}) => <blockquote className={`border-l-4 pl-4 py-2 my-4 italic rounded-r bg-opacity-50 ${isUserMessage ? 'border-white/50 bg-white/10 text-white/90' : (isDarkMode ? 'border-indigo-500 bg-indigo-900/20 text-slate-400' : 'border-indigo-600 bg-indigo-50 text-slate-600')}`} {...props} />,
                ul: ({node, ...props}) => <ul className={`list-disc pl-6 mb-4 space-y-2 ${isUserMessage ? 'marker:text-white/80' : 'marker:text-indigo-500'}`} {...props} />,
                ol: ({node, ...props}) => <ol className={`list-decimal pl-6 mb-4 space-y-2 ${isUserMessage ? 'marker:text-white/80' : 'marker:text-indigo-500'}`} {...props} />,
                li: ({node, ...props}) => <li className={`pl-1 ${textColor}`} {...props} />,
                a: ({node, ...props}) => <a className={`${isUserMessage ? 'text-white underline decoration-white/50 hover:decoration-white' : 'text-blue-500 hover:underline'} cursor-pointer font-medium`} target="_blank" rel="noopener noreferrer" {...props} />,
                hr: ({node, ...props}) => <hr className={`my-6 border-t ${borderColor}`} {...props} />,
                code: ({node, inline, className, children, ...props}) => !inline ? <CodeBlock language={/language-(\w+)/.exec(className || '')?.[1]} isDarkMode={isDarkMode} isUserMessage={isUserMessage}>{children}</CodeBlock> : <code className={`${isUserMessage ? 'bg-white/20 text-white border-white/20' : (isDarkMode ? 'bg-slate-800 text-indigo-300 border-slate-700' : 'bg-gray-100 text-indigo-700 border-gray-200')} px-1.5 py-0.5 rounded border text-xs font-mono tracking-tight`} {...props}>{children}</code>
            };
        };

        const TextWithMath = ({ content, isDarkMode, isUserMessage, isError }) => {
            const parts = content.split(/(\$\$[\s\S]*?\$\$|\$[\s\S]*?\$)/g);
            const components = { ...getMarkdownComponents(isDarkMode, isUserMessage, isError), p: ({node, ...props}) => <span {...props} /> };
            return <span>{parts.map((part, i) => part.startsWith('$$') ? <BlockMath key={i} math={part.slice(2, -2)} /> : part.startsWith('$') ? <InlineMath key={i} math={part.slice(1, -1)} /> : <ReactMarkdown key={i} components={components}>{part}</ReactMarkdown>)}</span>;
        };

        const SimpleTable = ({ content, isDarkMode }) => {
            const lines = content.trim().split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) return null;
            const parseRow = (row) => row.trim().replace(/^\|/, '').replace(/\|$/, '').split('|').map(c => c.trim());
            const headers = parseRow(lines[0]);
            const body = lines.slice(2);
            return (
                <div className="overflow-hidden my-6 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm">
                    <div className="overflow-x-auto custom-scrollbar">
                        <table className={`min-w-full divide-y ${isDarkMode ? 'divide-gray-700 bg-slate-800/50' : 'divide-gray-200 bg-white/50'} text-left text-sm backdrop-blur-sm`}>
                            <thead className={isDarkMode ? 'bg-slate-800' : 'bg-gray-50'}><tr>{headers.map((h, i) => <th key={i} className={`px-4 py-3 font-semibold uppercase tracking-wider text-xs ${isDarkMode ? 'text-indigo-300 border-gray-600' : 'text-indigo-600 border-gray-200'} border-b`}><TextWithMath content={h} isDarkMode={isDarkMode} /></th>)}</tr></thead>
                            <tbody className={`divide-y ${isDarkMode ? 'divide-gray-700' : 'divide-gray-200'}`}>{body.map((line, i) => <tr key={i} className={`transition-colors ${isDarkMode ? 'hover:bg-slate-700/50' : 'hover:bg-indigo-50/50'}`}>{parseRow(line).map((c, j) => <td key={j} className={`px-4 py-3 ${isDarkMode ? 'text-slate-300 border-gray-700' : 'text-slate-700 border-gray-100'} border-r last:border-r-0`}><TextWithMath content={c} isDarkMode={isDarkMode} /></td>)}</tr>)}</tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const MarkdownRenderer = ({ content, isDarkMode, fontSize, isUserMessage, isError }) => {
            useKatexStyles();
            const fontSizeClass = { 'small': 'text-sm', 'normal': 'text-base', 'large': 'text-lg' }[fontSize] || 'text-base';
            const components = getMarkdownComponents(isDarkMode, isUserMessage, isError);
            const renderContent = () => {
                if (content.startsWith('data:image/') || (content.startsWith('http') && (content.match(/\.(png|jpg|jpeg)$/)))) {
                    return <div className="relative group rounded-2xl overflow-hidden shadow-lg my-2"><img src={content} alt="Generated" className="w-full h-auto object-cover" /></div>;
                }
                return content.split(/(```[\s\S]*?```)/g).map((part, i) => {
                    if (part.startsWith('```')) return <ReactMarkdown key={i} components={components}>{part}</ReactMarkdown>;
                    return <span key={i}>{part.split(/((?:(?:^|\n)\|[^\n]+\|)+\r?\n(?:\|[-:| ]+\|)(?:\r?\n\|[^\n]+\|)+)/g).map((sub, j) => sub.match(/\|[-:| ]+\|/) ? <SimpleTable key={j} content={sub} isDarkMode={isDarkMode} /> : <TextWithMath key={j} content={sub} isDarkMode={isDarkMode} isUserMessage={isUserMessage} isError={isError} />)}</span>;
                });
            };
            return <div className={`prose max-w-none ${isDarkMode ? 'prose-invert' : ''} font-inter ${fontSizeClass} leading-relaxed animate-fade-in`}>{renderContent()}</div>;
        };

        const MathSolverAILogo = ({ size = 24, className = '' }) => (
            <div className={`relative flex items-center justify-center ${className}`} style={{ width: size, height: size }}>
                <svg viewBox="0 0 100 100" className="w-full h-full overflow-visible">
                    <defs>
                        <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stopColor="#4F46E5" /><stop offset="50%" stopColor="#8B5CF6" /><stop offset="100%" stopColor="#EC4899" /></linearGradient>
                        <filter id="glow"><feGaussianBlur stdDeviation="3" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
                    </defs>
                    <path d="M25,50 C25,30 40,30 50,50 C60,70 75,70 75,50 C75,30 60,30 50,50 C40,70 25,70 25,50 Z" fill="none" stroke="url(#logoGradient)" strokeWidth="8" strokeLinecap="round" filter="url(#glow)" className="animate-pulse-glow" />
                    <circle r="4" fill="#fff"><animateMotion dur="4s" repeatCount="indefinite" path="M25,50 C25,30 40,30 50,50 C60,70 75,70 75,50 C75,30 60,30 50,50 C40,70 25,70 25,50 Z" /></circle>
                    <circle r="3" fill="#A5B4FC"><animateMotion dur="4s" begin="2s" repeatCount="indefinite" path="M25,50 C25,30 40,30 50,50 C60,70 75,70 75,50 C75,30 60,30 50,50 C40,70 25,70 25,50 Z" /></circle>
                </svg>
            </div>
        );

        const AuthModal = ({ isDarkMode }) => {
            const [name, setName] = useState('');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [isSigningUp, setIsSigningUp] = useState(false);
            const [authError, setAuthError] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [showPassword, setShowPassword] = useState(false);
            const [showConfirmPassword, setShowConfirmPassword] = useState(false);
            const [strength, setStrength] = useState(0);
            // OTP States
            const [authStep, setAuthStep] = useState('details'); // 'details' or 'otp'
            const [generatedOtp, setGeneratedOtp] = useState('');
            const [inputOtp, setInputOtp] = useState('');
            // New state for OTP Notification
            const [otpNotification, setOtpNotification] = useState({ show: false, otp: '' });

            const calculateStrength = (pass) => {
                let s = 0;
                if (pass.length > 5) s++;
                if (pass.length > 7) s++;
                if (/[A-Z]/.test(pass)) s++;
                if (/[0-9]/.test(pass)) s++;
                if (/[^A-Za-z0-9]/.test(pass)) s++;
                return s; // Max 5
            };

            const handlePassChange = (e) => {
                const val = e.target.value;
                setPassword(val);
                setStrength(calculateStrength(val));
            };

            const generateOtpVal = () => {
                return Math.floor(100000 + Math.random() * 900000).toString();
            };

            const handleSignUpInitiate = async (e) => {
                e.preventDefault();
                setAuthError('');
                
                if (password !== confirmPassword) {
                    setAuthError("Passwords do not match.");
                    return;
                }
                if (strength < 3) {
                    setAuthError("Password is too weak. Include numbers/symbols.");
                    return;
                }

                setIsLoading(true);
                const newOtp = generateOtpVal();
                setGeneratedOtp(newOtp);

                // --- N8N EMAIL INTEGRATION WITH FALLBACK ---
                let emailSentSuccessfully = false;
                if (n8nWebhookUrl && n8nWebhookUrl.startsWith('http')) {
                    try {
                        const response = await fetch(n8nWebhookUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                email: email,
                                name: name,
                                otp: newOtp,
                                subject: "Verify your Math Solver Account"
                            })
                        });
                        
                        if (response.ok) {
                            emailSentSuccessfully = true;
                        }
                    } catch (error) {
                        console.error("n8n Error (Handled by Fallback):", error);
                    }
                }

                setIsLoading(false);
                if (emailSentSuccessfully) {
                    setAuthStep('otp');
                } else {
                    // Fallback to Demo Mode if n8n fails or no URL provided
                    setOtpNotification({ show: true, otp: newOtp });
                    setAuthStep('otp');
                    setTimeout(() => setOtpNotification({ show: false, otp: '' }), 15000);
                }
            };

            const handleVerifyAndCreate = async (e) => {
                e.preventDefault();
                setAuthError('');
                
                if (inputOtp !== generatedOtp) {
                    setAuthError("Invalid OTP. Please check your email.");
                    return;
                }

                setIsLoading(true);
                try {
                    await setPersistence(auth, browserLocalPersistence);
                    const cred = await createUserWithEmailAndPassword(auth, email, password);
                    await updateProfile(cred.user, { displayName: name });
                    await setDoc(doc(db, 'users', cred.user.uid), { customApiKey: null }, { merge: true });
                } catch (error) {
                    let msg = error.message.replace('Firebase: ', '');
                    if (msg.includes('auth/email-already-in-use')) msg = "Email already in use.";
                    setAuthError(msg);
                    setIsLoading(false);
                    if (msg.includes("already in use")) {
                        setAuthStep('details'); 
                    }
                }
            };

            const handleSignIn = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                setAuthError('');
                try {
                    await setPersistence(auth, browserLocalPersistence);
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    let msg = error.message.replace('Firebase: ', '');
                    if (msg.includes('auth/user-not-found') || msg.includes('auth/wrong-password') || msg.includes('auth/invalid-credential')) msg = "Invalid email or password.";
                    setAuthError(msg);
                    setIsLoading(false);
                }
            };

            const getStrengthColor = () => {
                if (strength < 2) return 'bg-red-500';
                if (strength < 4) return 'bg-yellow-500';
                return 'bg-blue-600';
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-cover bg-center transition-all duration-700" style={{ backgroundImage: `url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2072&auto=format&fit=crop')` }}>
                    <div className={`absolute inset-0 ${isDarkMode ? 'bg-slate-950/80' : 'bg-indigo-950/70'} backdrop-blur-md`}></div>
                    
                    {otpNotification.show && (
                        <div className="fixed top-4 left-1/2 -translate-x-1/2 z-[70] animate-slide-up-fade w-full max-w-sm px-4">
                            <div className="bg-white dark:bg-slate-800 border-l-4 border-indigo-500 shadow-2xl rounded-lg p-4 flex flex-col gap-2 relative">
                                <button onClick={() => setOtpNotification({ show: false, otp: '' })} className="absolute top-2 right-2 text-slate-400 hover:text-slate-600"><X size={16}/></button>
                                <div className="flex items-center gap-2 text-indigo-600 dark:text-indigo-400 font-bold text-sm">
                                    <Mail size={16} /> <span>OTP Helper (Fallback)</span>
                                </div>
                                <div className="text-xs text-slate-600 dark:text-slate-300">
                                    N8N link failed or not set. Use this code:
                                </div>
                                <div className="bg-indigo-50 dark:bg-indigo-900/30 p-3 rounded-md text-center">
                                    <p className="text-2xl font-mono font-bold tracking-[0.5em] text-indigo-600 dark:text-indigo-400">{otpNotification.otp}</p>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="relative flex w-full max-w-4xl h-auto min-h-[500px] md:h-[700px] rounded-3xl overflow-hidden shadow-2xl animate-scale-in flex-col md:flex-row glass-panel border-0">
                        <div className="hidden md:flex w-1/2 flex-col justify-center items-center p-12 relative overflow-hidden text-white">
                            <div className="absolute inset-0 bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 opacity-90 mix-blend-overlay"></div>
                            <div className="absolute inset-0 bg-black/10"></div>
                            <div className="relative z-10 flex flex-col items-center text-center">
                                <div className="mb-8 scale-150 animate-float"><MathSolverAILogo size={140} /></div>
                                <h1 className="text-5xl font-display font-extrabold mb-4 tracking-tight drop-shadow-lg">Math Solver</h1>
                                <p className="text-lg text-indigo-50 font-medium drop-shadow-md">Unlock your potential with intelligent problem solving.</p>
                            </div>
                        </div>
                        <div className={`w-full md:w-1/2 p-8 md:p-12 flex flex-col justify-center relative ${isDarkMode ? 'text-white' : 'text-slate-800'}`}>
                            
                            {authStep === 'otp' && isSigningUp ? (
                                <div className="animate-slide-up-fade w-full">
                                    <div className="mb-8 text-center md:text-left">
                                        <button onClick={() => setAuthStep('details')} className="text-sm text-indigo-500 font-bold mb-4 flex items-center gap-1 hover:underline"><ArrowRight size={14} className="rotate-180" /> Back</button>
                                        <h2 className="text-3xl font-bold font-display mb-2">Verify Email</h2>
                                        <p className={`text-sm ${isDarkMode ? 'text-slate-400' : 'text-slate-500'}`}>Enter the OTP sent to <span className="font-bold text-indigo-500">{email}</span></p>
                                    </div>
                                    <form onSubmit={handleVerifyAndCreate} className="space-y-4">
                                        <div className="space-y-1"><label className="text-xs font-bold uppercase tracking-wide ml-1 opacity-70">Enter OTP</label><div className="relative group"><Key className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 opacity-50" /><input type="text" name="otp" value={inputOtp} onChange={e => setInputOtp(e.target.value)} required placeholder="123456" className={`w-full pl-10 pr-4 py-3 rounded-xl border outline-none font-mono tracking-widest text-center text-lg ${isDarkMode ? 'bg-slate-800/50 border-slate-700 focus:border-indigo-500 text-white' : 'bg-slate-50 border-slate-200 focus:border-indigo-500'} focus:ring-2 focus:ring-indigo-500/20`} /></div></div>
                                        {authError && <div className="flex items-center gap-2 text-sm text-red-500 bg-red-500/10 p-3 rounded-xl animate-scale-in border border-red-500/20"><AlertTriangle size={16} /><span>{authError}</span></div>}
                                        <button type="submit" disabled={isLoading} className="group relative w-full py-3.5 px-4 rounded-xl font-bold text-white bg-gradient-to-r from-indigo-600 to-pink-600 hover:from-indigo-500 hover:to-pink-500 shadow-lg shadow-indigo-500/20 transition-all duration-300 active:scale-[0.98] disabled:opacity-70 overflow-hidden mt-4"><div className="absolute inset-0 bg-white/20 translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700 ease-in-out"></div>{isLoading ? <div className="flex items-center justify-center gap-2"><div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div><span>Verifying...</span></div> : <span className="flex items-center justify-center gap-2">Verify & Create Account <Check size={18} /></span>}</button>
                                    </form>
                                </div>
                            ) : (
                                <div className="animate-slide-up-fade w-full">
                                    <div className="mb-8 text-center md:text-left">
                                        <h2 className="text-3xl font-bold font-display mb-2">{isSigningUp ? 'Create Account' : 'Welcome Back'}</h2>
                                        <p className={`text-sm ${isDarkMode ? 'text-slate-400' : 'text-slate-500'}`}>{isSigningUp ? 'Join us to solve math problems instantly.' : 'Enter your details to continue.'}</p>
                                    </div>
                                    <form onSubmit={isSigningUp ? handleSignUpInitiate : handleSignIn} className="space-y-4">
                                        {isSigningUp && <div className="space-y-1 animate-slide-up-fade"><label className="text-xs font-bold uppercase tracking-wide ml-1 opacity-70">Full Name</label><div className="relative group"><User className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 opacity-50" /><input type="text" name="name" autoComplete="name" value={name} onChange={e => setName(e.target.value)} required placeholder="Your Name" className={`w-full pl-10 pr-4 py-3 rounded-xl border outline-none ${isDarkMode ? 'bg-slate-800/50 border-slate-700 focus:border-indigo-500 text-white' : 'bg-slate-50 border-slate-200 focus:border-indigo-500'} focus:ring-2 focus:ring-indigo-500/20`} /></div></div>}
                                        <div className="space-y-1"><label className="text-xs font-bold uppercase tracking-wide ml-1 opacity-70">Email</label><div className="relative group"><Mail className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 opacity-50" /><input type="email" name="email" autoComplete="email" value={email} onChange={e => setEmail(e.target.value)} required placeholder="name@example.com" className={`w-full pl-10 pr-4 py-3 rounded-xl border outline-none ${isDarkMode ? 'bg-slate-800/50 border-slate-700 focus:border-indigo-500 text-white' : 'bg-slate-50 border-slate-200 focus:border-indigo-500'} focus:ring-2 focus:ring-indigo-500/20`} /></div></div>
                                        
                                        <div className="space-y-1"><label className="text-xs font-bold uppercase tracking-wide ml-1 opacity-70">Password</label><div className="relative group"><Lock className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 opacity-50" /><input type={showPassword ? 'text' : 'password'} name="password" autoComplete="current-password" value={password} onChange={handlePassChange} required minLength={6} placeholder="••••••••" className={`w-full pl-10 pr-12 py-3 rounded-xl border outline-none ${isDarkMode ? 'bg-slate-800/50 border-slate-700 focus:border-indigo-500 text-white' : 'bg-slate-50 border-slate-200 focus:border-indigo-500'} focus:ring-2 focus:ring-indigo-500/20`} /><button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute inset-y-0 right-0 px-3 flex items-center opacity-50 hover:opacity-100">{showPassword ? <EyeOff size={18} /> : <Eye size={18} />}</button></div>
                                        {isSigningUp && (
                                            <div className="w-full h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full mt-2 overflow-hidden">
                                                <div className={`h-full transition-all duration-300 ${getStrengthColor()}`} style={{ width: `${(strength / 5) * 100}%` }}></div>
                                            </div>
                                        )}
                                        </div>
                                        
                                        {isSigningUp && (
                                            <div className="space-y-1 animate-slide-up-fade">
                                                <label className="text-xs font-bold uppercase tracking-wide ml-1 opacity-70">Confirm Password</label>
                                                <div className="relative group">
                                                    <Lock className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 opacity-50" />
                                                    <input type={showConfirmPassword ? 'text' : 'password'} name="confirmPassword" value={confirmPassword} onChange={e => setConfirmPassword(e.target.value)} required minLength={6} placeholder="••••••••" className={`w-full pl-10 pr-12 py-3 rounded-xl border outline-none ${isDarkMode ? 'bg-slate-800/50 border-slate-700 focus:border-indigo-500 text-white' : 'bg-slate-50 border-slate-200 focus:border-indigo-500'} focus:ring-2 focus:ring-indigo-500/20 ${confirmPassword && confirmPassword !== password ? 'border-red-500' : ''}`} />
                                                    <button type="button" onClick={() => setShowConfirmPassword(!showConfirmPassword)} className="absolute inset-y-0 right-0 px-3 flex items-center opacity-50 hover:opacity-100">
                                                        {showConfirmPassword ? <EyeOff size={18} /> : <Eye size={18} />}
                                                    </button>
                                                </div>
                                            </div>
                                        )}
                                        {authError && <div className="flex items-center gap-2 text-sm text-red-500 bg-red-500/10 p-3 rounded-xl animate-scale-in border border-red-500/20"><AlertTriangle size={16} /><span>{authError}</span></div>}
                                        <button type="submit" disabled={isLoading} className="group relative w-full py-3.5 px-4 rounded-xl font-bold text-white bg-gradient-to-r from-indigo-600 to-pink-600 hover:from-indigo-500 hover:to-pink-500 shadow-lg shadow-indigo-500/20 transition-all duration-300 active:scale-[0.98] disabled:opacity-70 overflow-hidden mt-4"><div className="absolute inset-0 bg-white/20 translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700 ease-in-out"></div>{isLoading ? <div className="flex items-center justify-center gap-2"><div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div><span>Processing...</span></div> : <span className="flex items-center justify-center gap-2">{isSigningUp ? 'Next' : 'Sign In'} <ArrowRight size={18} /></span>}</button>
                                    </form>
                                    <div className="mt-8 text-center"><p className={`text-sm ${isDarkMode ? 'text-slate-400' : 'text-slate-500'}`}>{isSigningUp ? 'Already have an account?' : "Don't have an account?"}<button type="button" onClick={() => { setIsSigningUp(!isSigningUp); setAuthError(''); setName(''); setPassword(''); setConfirmPassword(''); setAuthStep('details'); }} className="font-bold text-indigo-500 hover:text-indigo-400 ml-1 hover:underline transition-colors">{isSigningUp ? 'Sign In' : 'Sign Up'}</button></p></div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const ConfirmModal = ({ isOpen, title, message, onConfirm, onCancel, isDarkMode }) => !isOpen ? null : (
            <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm animate-fade-in">
                <div className={`w-full max-w-sm rounded-2xl shadow-2xl p-6 transform scale-100 animate-scale-in border ${isDarkMode ? 'bg-slate-900 border-slate-700' : 'bg-white border-slate-200'}`}>
                    <h3 className={`text-lg font-bold font-display mb-2 ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>{title}</h3>
                    <p className={`text-sm mb-6 ${isDarkMode ? 'text-slate-400' : 'text-slate-600'}`}>{message}</p>
                    <div className="flex justify-end gap-3">
                        <button onClick={onCancel} className={`px-4 py-2 rounded-xl text-sm font-semibold transition-colors ${isDarkMode ? 'bg-slate-800 text-slate-300 hover:bg-slate-700' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}`}>Cancel</button>
                        <button onClick={onConfirm} className="px-4 py-2 rounded-xl text-sm font-semibold text-white bg-red-500 hover:bg-red-600 transition-colors shadow-lg shadow-red-500/20">Delete</button>
                    </div>
                </div>
            </div>
        );

        function App() {
            const [currentUser, setCurrentUser] = useState(null);
            const [isAuthLoading, setIsAuthLoading] = useState(true);
            const [isSidebarOpen, setIsSidebarOpen] = useState(window.innerWidth > 768);
            const [messages, setMessages] = useState([]);
            const [inputValue, setInputValue] = useState('');
            const [loadingState, setLoadingState] = useState('idle');
            const [showLanding, setShowLanding] = useState(true);
            const [showSettings, setShowSettings] = useState(false);
            const [recentChats, setRecentChats] = useState([]);
            const [currentChatId, setCurrentChatId] = useState(null);
            
            // --- THEME STATE (Dark, Light, Device) ---
            const [theme, setTheme] = useState(safeLocalStorage.getItem('math_solver_theme') || 'device');
            const [isDarkMode, setIsDarkMode] = useState(true); 

            const [copiedMessageId, setCopiedMessageId] = useState(null);
            const [attachments, setAttachments] = useState([]);
            const [feedbacks, setFeedbacks] = useState({}); 
            const [fontSize, setFontSize] = useState('normal'); 
            const [language, setLanguage] = useState('auto');
            const [userPhoto, setUserPhoto] = useState(null); 
            
            const [customApiKey, setCustomApiKey] = useState(defaultApiKey); 
            const [tempApiKey, setTempApiKey] = useState(''); 
            const [apiStatus, setApiStatus] = useState('idle'); 
            const [confirmModal, setConfirmModal] = useState({ isOpen: false, type: null, id: null });
            
            const [menuOpenId, setMenuOpenId] = useState(null);
            const [renamingId, setRenamingId] = useState(null);
            const [renameText, setRenameText] = useState("");

            const [isAttachMenuOpen, setIsAttachMenuOpen] = useState(false);
            const attachMenuRef = useRef(null);
            
            const messagesEndRef = useRef(null);
            const inputRef = useRef(null);
            const fileInputRef = useRef(null);
            const readingTimeoutRef = useRef(null);
            const profilePhotoInputRef = useRef(null);

            useEffect(() => {
                const root = document.documentElement;
                const applyTheme = (t) => {
                    let isDark = false;
                    if (t === 'dark') isDark = true;
                    else if (t === 'light') isDark = false;
                    else if (t === 'device') isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    
                    setIsDarkMode(isDark);
                    if (isDark) root.classList.add('dark');
                    else root.classList.remove('dark');
                };

                applyTheme(theme);
                safeLocalStorage.setItem('math_solver_theme', theme);

                if (theme === 'device') {
                    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                    const handleChange = () => applyTheme('device');
                    mediaQuery.addEventListener('change', handleChange);
                    return () => mediaQuery.removeEventListener('change', handleChange);
                }
            }, [theme]);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (attachMenuRef.current && !attachMenuRef.current.contains(event.target)) {
                        setIsAttachMenuOpen(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            useEffect(() => {
                if (!menuOpenId) return;
                const handleMenuClickOutside = (event) => {
                    const closest = event.target.closest('[data-chat-id]');
                    if (!closest || closest.getAttribute('data-chat-id') !== menuOpenId) {
                        setMenuOpenId(null);
                    }
                };
                document.addEventListener('mousedown', handleMenuClickOutside);
                return () => document.removeEventListener('mousedown', handleMenuClickOutside);
            }, [menuOpenId]);

            useEffect(() => {
                const handleResize = () => setIsSidebarOpen(window.innerWidth > 768);
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            const loadApiKey = useCallback(async (uid) => {
                const userDocRef = doc(db, 'users', uid);
                try {
                    const userDocSnap = await getDoc(userDocRef);
                    let apiKey = defaultApiKey;
                    let status = 'idle';
                    if (userDocSnap.exists() && userDocSnap.data().customApiKey) {
                        apiKey = userDocSnap.data().customApiKey;
                        status = 'valid';
                    } else if (apiKey) {
                        status = 'valid';
                    } else {
                        status = 'invalid';
                    }
                    setCustomApiKey(apiKey);
                    setTempApiKey(apiKey || '');
                    setApiStatus(apiKey ? status : 'idle');
                } catch (error) {
                    setCustomApiKey(defaultApiKey);
                    setTempApiKey(defaultApiKey || '');
                    setApiStatus(defaultApiKey ? 'valid' : 'invalid');
                }
            }, []);

            useEffect(() => {
                setPersistence(auth, browserLocalPersistence).catch(e => console.error("Persistence failed:", e));
                return onAuthStateChanged(auth, (user) => {
                    if (user) { 
                        setCurrentUser(user);
                        loadApiKey(user.uid);
                    } 
                    else { 
                        setCurrentUser(null); 
                        setMessages([]); 
                        setRecentChats([]); 
                        setCurrentChatId(null); 
                        setShowLanding(true); 
                        setUserPhoto(null); 
                        setCustomApiKey(defaultApiKey);
                    }
                    setIsAuthLoading(false);
                });
            }, [loadApiKey]);

            useEffect(() => {
                if (!currentUser) return;
                return onSnapshot(doc(db, 'users', currentUser.uid), (snap) => {
                    const data = snap.data();
                    if (data?.photoBase64) setUserPhoto(data.photoBase64);
                    if (data?.customApiKey !== undefined && data.customApiKey !== customApiKey) {
                        setCustomApiKey(data.customApiKey || defaultApiKey);
                        setTempApiKey(data.customApiKey || '');
                        setApiStatus(data.customApiKey ? 'valid' : (defaultApiKey ? 'valid' : 'idle'));
                    }
                });
            }, [currentUser, customApiKey]);

            useEffect(() => {
                if (!currentUser) { setRecentChats([]); return; }
                const q = query(collection(db, 'users', currentUser.uid, 'chats')); 
                return onSnapshot(q, (snapshot) => {
                    const chats = [];
                    snapshot.forEach((doc) => chats.push({ id: doc.id, ...doc.data() }));
                    chats.sort((a, b) => {
                        if (a.isPinned && !b.isPinned) return -1;
                        if (!a.isPinned && b.isPinned) return 1;
                        return (b.lastUpdated?.seconds || 0) - (a.lastUpdated?.seconds || 0);
                    });
                    setRecentChats(chats);
                });
            }, [currentUser]);

            useEffect(() => {
                if (!currentUser || !currentChatId) { setMessages([]); return; }
                return onSnapshot(doc(db, 'users', currentUser.uid, 'chats', currentChatId), (snap) => {
                    if (snap.exists()) {
                        const data = snap.data();
                        setMessages((data.messages || []).map(msg => {
                            if (msg.attachments) msg.attachments = msg.attachments.map(att => att.preview === 'image_preview_placeholder' ? { ...att, preview: null } : att);
                            if (msg.timestamp?.toDate) msg.timestamp = msg.timestamp.toDate().getTime();
                            return msg;
                        }));
                        setShowLanding(false);
                    } else { setMessages([]); setShowLanding(true); setCurrentChatId(null); }
                });
            }, [currentUser, currentChatId]);

            const toggleSidebar = () => setIsSidebarOpen(!isSidebarOpen);
            const toggleSettings = () => setShowSettings(!showSettings);

            const validateAndSaveApiKey = async (key) => {
                if (!currentUser) return;
                if (!key) { 
                    setTempApiKey('');
                    setCustomApiKey(defaultApiKey); 
                    setApiStatus(defaultApiKey ? 'valid' : 'idle');
                    await setDoc(doc(db, 'users', currentUser.uid), { customApiKey: null }, { merge: true });
                    return;
                }
                setApiStatus('validating');
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: "Hello" }] }] })
                    });
                    if (res.ok) { 
                        setApiStatus('valid'); 
                        setCustomApiKey(key);
                        setTempApiKey(key);
                        await setDoc(doc(db, 'users', currentUser.uid), { customApiKey: key }, { merge: true });
                    } else { 
                        setApiStatus('invalid');
                    }
                } catch (e) { 
                    setApiStatus('invalid'); 
                }
            };

            const handleShare = async () => {
                const data = { title: 'Math Solver AI', text: 'Check out this amazing AI Math Solver!', url: window.location.href };
                try { if (navigator.share) await navigator.share(data); else { await navigator.clipboard.writeText(window.location.href); alert('Link copied!'); } } catch (e) { }
            };

            const startNewChat = () => { setShowLanding(true); setMessages([]); setCurrentChatId(null); setFeedbacks({}); setAttachments([]); if (window.innerWidth <= 768) setIsSidebarOpen(false); };
            
            const handlePinChat = async (e, id, currentStatus) => {
                e.stopPropagation();
                setMenuOpenId(null);
                await updateDoc(doc(db, 'users', currentUser.uid, 'chats', id), { isPinned: !currentStatus });
            }
            const handleRenameStart = (e, id, currentTitle) => {
                e.stopPropagation();
                setMenuOpenId(null);
                setRenamingId(id);
                setRenameText(currentTitle);
            }
            const handleRenameSubmit = async (id) => {
                if(renameText.trim()) await updateDoc(doc(db, 'users', currentUser.uid, 'chats', id), { title: renameText });
                setRenamingId(null);
            }
            const initiateDeleteChat = (e, chatId) => { e.stopPropagation(); setMenuOpenId(null); setConfirmModal({ isOpen: true, type: 'single', id: chatId }); };
            const initiateClearAllChats = () => setConfirmModal({ isOpen: true, type: 'all', id: null });
            const confirmAction = async () => {
                if (!currentUser) return;
                const { type, id } = confirmModal;
                setConfirmModal({ isOpen: false, type: null, id: null });
                try {
                    if (type === 'single' && id) { await deleteDoc(doc(db, 'users', currentUser.uid, 'chats', id)); if (currentChatId === id) startNewChat(); }
                    else if (type === 'all') { const batch = writeBatch(db); (await getDocs(collection(db, 'users', currentUser.uid, 'chats'))).forEach(doc => batch.delete(doc.ref)); await batch.commit(); startNewChat(); setShowSettings(false); }
                    else if (type === 'current' && currentChatId) { await deleteDoc(doc(db, 'users', currentUser.uid, 'chats', currentChatId)); startNewChat(); }
                } catch (e) { }
            };

            const loadChat = (id) => { setCurrentChatId(id); setFeedbacks({}); setAttachments([]); if (window.innerWidth <= 768) setIsSidebarOpen(false); };
            useEffect(() => messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }), [messages, loadingState]);

            const handleCopy = (text, id) => {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                textArea.style.top = "0";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    setCopiedMessageId(id);
                    setTimeout(() => setCopiedMessageId(null), 2000);
                } catch (err) { }
                document.body.removeChild(textArea);
            };

            const handleFeedback = (idx, type) => setFeedbacks(prev => { const curr = prev[idx]; if (curr === type) { const n = { ...prev }; delete n[idx]; return n; } return { ...prev, [idx]: type }; });

            const handleAIAction = (action) => {
                let prompt = "";
                if (action === 'practice') prompt = "Give me a similar practice problem to solve based on the previous solution.";
                else if (action === 'simplify') prompt = "Can you explain this again but in simpler terms?";
                if (prompt) handleSendMessage(prompt);
            };

            const handleSendMessage = async (text, isRegeneration = false) => {
                if (!currentUser) return;
                let queryStr = text || inputValue;
                let currentAttachments = [...attachments];
                let historyForApi = [...messages];
                let activeChatId = currentChatId;
                const ts = Date.now();

                const newUserMessage = { role: 'user', content: queryStr, attachments: currentAttachments.map(att => ({ name: att.name, type: att.type, preview: att.preview ? 'image_preview_placeholder' : null })), timestamp: ts };
                const attachmentsForApi = currentAttachments.map(att => ({ mimeType: att.type, data: att.data }));

                if (isRegeneration) {
                    const lastIdx = messages.findLastIndex(m => m.role === 'user');
                    if (lastIdx === -1) return;
                    queryStr = messages[lastIdx].content;
                    currentAttachments = [];
                    if (messages.length > lastIdx + 1 && messages[messages.length - 1].role === 'model') { historyForApi = messages.slice(0, -1); setMessages(prev => prev.slice(0, -1)); }
                } else {
                    if (!queryStr.trim() && attachments.length === 0) return;
                    setShowLanding(false); setInputValue(''); setAttachments([]); if (inputRef.current) inputRef.current.style.height = 'auto';
                    setMessages(prev => [...prev, { ...newUserMessage, attachments: currentAttachments, timestamp: ts }]);
                    historyForApi = [...messages, { ...newUserMessage, attachments: currentAttachments }];
                }

                if (!activeChatId) {
                    try {
                        const title = (historyForApi[0].content && historyForApi[0].content.trim()) ? historyForApi[0].content.substring(0, 20) + (historyForApi[0].content.length > 20 ? '...' : '') : 'New Chat';
                        const ref = await addDoc(collection(db, 'users', currentUser.uid, 'chats'), { title, messages: [newUserMessage], createdAt: serverTimestamp(), lastUpdated: serverTimestamp() });
                        activeChatId = ref.id; setCurrentChatId(ref.id);
                    } catch (e) { setLoadingState('idle'); return; }
                } else if (!isRegeneration) {
                    try { await updateDoc(doc(db, 'users', currentUser.uid, 'chats', activeChatId), { messages: arrayUnion(newUserMessage), lastUpdated: serverTimestamp() }); } catch (e) { }
                }

                const key = customApiKey || defaultApiKey;
                if (!key) {
                    setLoadingState('idle');
                    const err = { role: 'model', content: "API Key Missing", timestamp: Date.now(), isError: true };
                    try { if (activeChatId) await updateDoc(doc(db, 'users', currentUser.uid, 'chats', activeChatId), { messages: arrayUnion(err), lastUpdated: serverTimestamp() }); } catch (e) { }
                    return;
                }

                if (attachmentsForApi.length > 0) { setLoadingState('reading'); readingTimeoutRef.current = setTimeout(() => setLoadingState('thinking'), 2000); } else { setLoadingState('thinking'); }
                await callModel(queryStr, attachmentsForApi, key, historyForApi, isRegeneration, activeChatId);
            };

            const callModel = async (queryStr, atts, key, history, isRegen, chatId) => {
                let modelMsg = { role: 'model', content: "Error", isImage: false, timestamp: Date.now() };
                try {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
                    const hist = isRegen ? history.slice(0, history.findLastIndex(m => m.role === 'user')) : history.slice(0, -1);
                    const contents = [
                        ...hist.filter(m => !m.isImage).map(m => ({ role: m.role, parts: [{ text: m.content || '[Image]' }, ...(m.role === 'user' && m.attachments?.length ? [{ text: `\n[${m.attachments.length} files attached]` }] : [])] })),
                        { role: "user", parts: [{ text: queryStr || "Analyze files" }, ...atts.map(a => ({ inlineData: a }))] }
                    ];
                    
                    const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents, systemInstruction: { parts: [{ text: `You are "Math Solver" (গণিত সহায়ক)...` }] }, generationConfig: { temperature: 0.3 } }) });
                    if (!res.ok) throw new Error("API Error");
                    const data = await res.json();
                    modelMsg.content = data.candidates?.[0]?.content?.parts?.[0]?.text || "No response";
                } catch (e) { modelMsg.content = "Connection Error"; } 
                finally {
                    try { if (chatId) await updateDoc(doc(db, 'users', currentUser.uid, 'chats', chatId), { messages: arrayUnion(modelMsg), lastUpdated: serverTimestamp() }); } catch (e) { }
                    setLoadingState('idle'); 
                }
            };

            const triggerFileInput = (acceptType) => { if (fileInputRef.current) { fileInputRef.current.accept = acceptType || "*/*"; fileInputRef.current.click(); } };
            const handleFileChange = async (e) => {
                const files = Array.from(e.target.files);
                if (!files.length) return;
                const newAtts = await Promise.all(files.map(f => new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve({ name: f.name, type: f.type, preview: f.type.startsWith('image/') ? reader.result : null, data: reader.result.split(',')[1] });
                    reader.readAsDataURL(f);
                })));
                setAttachments(prev => [...prev, ...newAtts]);
                setIsAttachMenuOpen(false); 
            };

            const handleProfilePhotoUpload = (e) => {
                const f = e.target.files[0]; if (!f) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = new Image();
                    img.onload = async () => {
                        const cvs = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > h) { if (w > 150) { h *= 150/w; w = 150; } } else { if (h > 150) { w *= 150/h; h = 150; } }
                        cvs.width = w; cvs.height = h;
                        cvs.getContext("2d").drawImage(img, 0, 0, w, h);
                        try { await setDoc(doc(db, 'users', currentUser.uid), { photoBase64: cvs.toDataURL("image/jpeg", 0.7) }, { merge: true }); } catch (e) {}
                    };
                    img.src = ev.target.result;
                };
                reader.readAsDataURL(f);
            };

            const handlePaste = async (e) => {
                const items = Array.from(e.clipboardData.files).filter(f => f.type.startsWith('image/'));
                if (items.length) {
                    e.preventDefault();
                    const newAtts = await Promise.all(items.map(f => new Promise(res => {
                        const r = new FileReader();
                        r.onloadend = () => res({ name: f.name || 'pasted.png', type: f.type, preview: r.result, data: r.result.split(',')[1] });
                        r.readAsDataURL(f);
                    })));
                    setAttachments(prev => [...prev, ...newAtts]);
                }
            };
            const removeAttachment = (i) => setAttachments(prev => prev.filter((_, idx) => idx !== i));
            const handleSignOut = () => signOut(auth);
            const UserAvatar = ({ size = 24 }) => userPhoto ? <img src={userPhoto} className="rounded-full object-cover border border-white/10" style={{ width: size, height: size }} /> : <div className={`rounded-full flex items-center justify-center ${isDarkMode ? 'bg-slate-800' : 'bg-slate-200'}`} style={{ width: size, height: size }}><User size={size * 0.6} className={isDarkMode ? 'text-indigo-400' : 'text-indigo-600'} /></div>;
            const isSendDisabled = (!inputValue.trim() && attachments.length === 0) || loadingState !== 'idle';

            if (isAuthLoading) return <div className={`flex h-screen w-full items-center justify-center ${isDarkMode ? 'bg-slate-950' : 'bg-slate-50'}`}><div className="animate-float"><MathSolverAILogo size={100} /></div></div>;
            if (!currentUser) return <AuthModal isDarkMode={isDarkMode} />;

            return (
                <div className={`flex h-[100dvh] font-inter overflow-hidden transition-colors duration-500 ${isDarkMode ? 'bg-slate-950 text-slate-200' : 'bg-slate-50 text-slate-800'}`}>
                    <ConfirmModal isOpen={confirmModal.isOpen} title={confirmModal.type === 'all' ? 'Delete All?' : 'Delete Chat?'} message="This cannot be undone." onConfirm={confirmAction} onCancel={() => setConfirmModal({ isOpen: false })} isDarkMode={isDarkMode} />
                    
                    {showSettings && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center p-4 animate-fade-in">
                            <div className="rounded-3xl w-full max-w-md shadow-2xl flex flex-col max-h-[90vh] glass-panel overflow-hidden animate-scale-in border border-white/10 dark:border-white/5">
                                <div className={`p-6 border-b ${isDarkMode ? 'border-white/10 bg-slate-900/50' : 'bg-white/50 border-black/5'}`}>
                                    <div className="flex items-center gap-4">
                                        <div className="relative group cursor-pointer" onClick={() => profilePhotoInputRef.current?.click()}>
                                            <div className="w-16 h-16 rounded-full bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 p-[2px] shadow-lg"><div className={`w-full h-full rounded-full flex items-center justify-center overflow-hidden ${isDarkMode ? 'bg-slate-900' : 'bg-white'}`}><UserAvatar size={64} /></div></div>
                                            <div className="absolute bottom-0 right-0 w-6 h-6 rounded-full bg-indigo-600 border-2 border-white flex items-center justify-center text-white"><Camera size={12} /></div>
                                            <input type="file" ref={profilePhotoInputRef} onChange={handleProfilePhotoUpload} accept="image/*" className="hidden" />
                                        </div>
                                        <div><h2 className="text-xl font-bold">{currentUser.displayName || 'User'}</h2><p className="text-sm opacity-70">{currentUser.email}</p></div>
                                    </div>
                                </div>
                                <div className={`flex items-center justify-between p-5 border-b ${isDarkMode ? 'border-white/10' : 'border-black/5'}`}>
                                    <h2 className="text-xl font-bold flex items-center gap-2"><Settings size={22} className="text-indigo-500" /> Settings</h2>
                                    <button onClick={toggleSettings} className="p-2 rounded-full hover:bg-black/5 transition"><X size={20} /></button>
                                </div>
                                <div className="p-5 space-y-6 overflow-y-auto custom-scrollbar">
                                    <div>
                                        <h3 className="text-xs font-bold uppercase tracking-wider mb-3 ml-1 opacity-60">Appearance</h3>
                                        <div className={`p-1.5 rounded-2xl border flex ${isDarkMode ? 'bg-black/20 border-white/5' : 'bg-slate-100 border-black/5'}`}>
                                            {['light', 'dark', 'device'].map(t => (
                                                <button key={t} onClick={() => setTheme(t)} className={`flex-1 py-2 px-3 rounded-xl text-sm font-semibold transition-all capitalize ${theme === t ? (isDarkMode ? 'bg-slate-800 text-white shadow-md' : 'bg-white text-slate-900 shadow-sm') : 'opacity-60 hover:opacity-100'}`}>
                                                    {t}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    <div>
                                        <h3 className="text-xs font-bold uppercase tracking-wider mb-3 ml-1 opacity-60">Connections</h3>
                                        <div className={`p-4 rounded-2xl border ${isDarkMode ? 'bg-white/5 border-white/5' : 'bg-black/5 border-black/5'}`}>
                                            <label className="block text-xs font-semibold mb-2">Gemini API Key</label>
                                            <div className="flex gap-2 mb-2">
                                                <div className="relative flex-1">
                                                    <Key size={14} className="absolute left-3 top-1/2 -translate-y-1/2 opacity-50" />
                                                    <input type="password" value={tempApiKey} onChange={e => setTempApiKey(e.target.value)} placeholder="API Key" className="w-full pl-9 pr-3 py-2 rounded-xl text-sm outline-none border bg-transparent" />
                                                </div>
                                                <button onClick={() => validateAndSaveApiKey(tempApiKey)} disabled={apiStatus === 'validating'} className={`px-4 py-2 rounded-xl text-sm font-bold text-white transition-all ${apiStatus === 'validating' ? 'bg-slate-500' : 'bg-indigo-600'}`}>
                                                    {apiStatus === 'validating' ? '...' : 'Save'}
                                                </button>
                                            </div>
                                            <a href="[https://aistudio.google.com/api-keys](https://aistudio.google.com/api-keys)" target="_blank" rel="noopener noreferrer" className={`mt-3 block text-center font-bold text-indigo-500 hover:text-indigo-400 transition-colors border-t border-white/5 pt-3 text-xs`}>
                                                Get API Key
                                            </a>
                                        </div>
                                    </div>
                                    <div>
                                        <button onClick={initiateClearAllChats} className={`w-full flex items-center justify-between p-4 rounded-2xl border mb-2 transition hover:border-red-500/30 hover:bg-red-500/5 group ${isDarkMode ? 'bg-white/5 border-white/5' : 'bg-black/5 border-black/5'}`}><div className="flex items-center gap-3"><div className="p-2 rounded-lg bg-red-500/10 text-red-500"><Trash2 size={18} /></div><span className="font-semibold">Clear History</span></div><ChevronRight size={16} className="opacity-50" /></button>
                                        <button onClick={handleSignOut} className={`w-full flex items-center justify-between p-4 rounded-2xl border transition hover:bg-black/5 ${isDarkMode ? 'bg-white/5 border-white/5' : 'bg-black/5 border-black/5'}`}><div className="flex items-center gap-3"><div className="p-2 rounded-lg bg-white/10"><LogOut size={18} /></div><span className="font-semibold">Sign Out</span></div><ChevronRight size={16} className="opacity-50" /></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className={`fixed inset-y-0 left-0 z-30 transform transition-all duration-300 ${isSidebarOpen ? 'translate-x-0 w-80' : '-translate-x-full md:translate-x-0 md:w-20'} md:relative backdrop-blur-xl flex flex-col shadow-2xl md:shadow-none ${isDarkMode ? 'bg-slate-900/50 border-r border-white/5' : 'bg-white/80 border-r border-black/5'}`}>
                        <div className={`${isSidebarOpen ? 'p-6' : 'p-4 justify-center'} flex items-center justify-between transition-all duration-300`}>
                            <div className="flex items-center gap-3"><MathSolverAILogo size={40} /><div className={!isSidebarOpen ? 'md:hidden' : ''}><h1 className="font-bold text-lg leading-tight">Math Solver</h1></div></div>
                            <button onClick={toggleSidebar} className="md:hidden p-2 rounded-full hover:bg-black/5"><X size={20} /></button>
                        </div>
                        <div className="px-4 pb-6"><button onClick={startNewChat} className="w-full flex items-center justify-center gap-2 px-4 py-3.5 bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 text-white rounded-2xl font-semibold shadow-lg active:scale-[0.98] transition-transform"><Plus strokeWidth={2.5} /><span className={!isSidebarOpen ? 'md:hidden' : ''}>New Chat</span></button></div>
                        <div className="flex-1 overflow-y-auto px-4 py-2 custom-scrollbar space-y-2">
                            {isSidebarOpen && (
                                <>
                                    <div className="flex items-center justify-between text-xs font-bold mb-4 px-2 uppercase tracking-wider opacity-60"><div className="flex items-center gap-2"><History size={14} /><span>History</span></div></div>
                                    {recentChats.map(c => (
                                        <div key={c.id} onClick={() => loadChat(c.id)} className={`relative flex items-center justify-between px-3.5 py-3 rounded-xl cursor-pointer transition border group ${currentChatId === c.id ? 'bg-indigo-500/10 text-indigo-500 border-indigo-500/20' : 'border-transparent hover:bg-black/5'}`}>
                                            <span className="truncate text-sm font-medium">{c.title || 'New Chat'}</span>
                                            <div className="relative" data-chat-id={c.id}>
                                                <button onClick={(e)=>{e.stopPropagation(); setMenuOpenId(menuOpenId === c.id ? null : c.id);}} className={`p-1.5 rounded-lg opacity-0 group-hover:opacity-100 transition hover:bg-black/10 ${menuOpenId === c.id ? 'opacity-100 bg-black/10' : ''}`}>
                                                    <MoreHorizontal size={16} />
                                                </button>
                                                {menuOpenId === c.id && (
                                                    <div className={`absolute right-0 top-full mt-1 w-32 rounded-xl shadow-xl border overflow-hidden z-50 animate-scale-in ${isDarkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-gray-200'}`} onClick={e=>e.stopPropagation()}>
                                                        <button onClick={(e)=>initiateDeleteChat(e, c.id)} className="flex items-center gap-2 w-full px-3 py-2 text-xs font-medium hover:bg-red-500/10 text-red-500 text-left"><Trash2 size={12}/> Delete</button>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </>
                            )}
                        </div>
                        <div className={`p-4 border-t ${isDarkMode ? 'border-white/5' : 'border-black/5'}`}><button onClick={toggleSettings} className={`w-full flex items-center ${isSidebarOpen ? 'gap-3 px-4' : 'justify-center px-0'} py-3 rounded-xl hover:bg-black/5 font-medium transition`}><Settings size={20} /><span className={!isSidebarOpen ? 'md:hidden' : ''}>Settings</span></button></div>
                    </div>

                    <div className="flex-1 flex flex-col relative min-w-0">
                        <header className={`h-16 md:h-20 flex items-center px-4 md:px-6 z-10 justify-between backdrop-blur-md sticky top-0 border-b ${isDarkMode ? 'bg-slate-950/80 border-white/5' : 'bg-white/80 border-black/5'}`}>
                            <div className="flex items-center"><button onClick={toggleSidebar} className="p-2 rounded-xl mr-3 hover:bg-black/5"><Menu size={24} /></button></div>
                            <div className="flex items-center gap-2"><UserAvatar size={36} /></div>
                        </header>

                        <main className="flex-1 relative flex flex-col overflow-y-auto custom-scrollbar px-4 pb-32 md:pb-4">
                            {showLanding ? (
                                <div className="flex-1 w-full flex flex-col items-center justify-start md:justify-center p-4 md:p-12 text-center animate-fade-in relative pt-12 md:pt-6">
                                    <MathSolverAILogo size={120} className="mb-8" />
                                    <h1 className="text-4xl md:text-6xl font-extrabold mb-6 font-display bg-clip-text text-transparent bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 text-center">Master Math & Creativity</h1>
                                </div>
                            ) : (
                                <div className="flex-1 py-6 md:py-10 flex flex-col gap-8 max-w-4xl mx-auto w-full">
                                    {messages.map((msg, idx) => (
                                        <div key={idx} className={`flex gap-4 md:gap-6 ${msg.role === 'user' ? 'justify-end' : ''} animate-slide-up`}>
                                            {msg.role === 'model' && <div className="w-10 h-10 flex-shrink-0 rounded-full shadow-lg border flex items-center justify-center overflow-hidden bg-white dark:bg-slate-900"><MathSolverAILogo size={40} /></div>}
                                            <div className={`max-w-[85%] ${msg.role === 'user' ? 'order-first' : 'w-full'}`}>
                                                <div className={`px-5 py-3 rounded-[2rem] shadow-sm animate-fade-in ${msg.role === 'user' ? 'bg-indigo-600 text-white rounded-br-none ml-auto' : (isDarkMode ? 'bg-slate-900 border border-white/5 rounded-bl-none' : 'bg-white border border-gray-100 rounded-bl-none')}`}>
                                                    <MarkdownRenderer content={msg.content} isDarkMode={isDarkMode} fontSize={fontSize} isUserMessage={msg.role === 'user'} />
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                    {loadingState !== 'idle' && <div className="text-center p-4 animate-pulse">Thinking...</div>}
                                    <div ref={messagesEndRef} className="h-6" />
                                </div>
                            )}
                        </main>

                        <div className="p-4 pb-6 pb-safe relative z-20">
                            <div className="max-w-3xl mx-auto relative">
                                <div className={`rounded-[2rem] shadow-2xl ring-1 ${isDarkMode ? 'bg-slate-900/90 ring-white/10' : 'bg-white ring-black/5'} backdrop-blur-xl relative`}>
                                    <div className="flex items-end p-2 pl-3">
                                        <input type="file" multiple ref={fileInputRef} onChange={handleFileChange} className="hidden" />
                                        <button onClick={() => setIsAttachMenuOpen(!isAttachMenuOpen)} className="p-3 mb-1 rounded-full"><Plus size={24} /></button>
                                        <textarea ref={inputRef} value={inputValue} onChange={e => { setInputValue(e.target.value); e.target.style.height='auto'; e.target.style.height=`${Math.min(e.target.scrollHeight,150)}px`; }} placeholder="Ask math problems..." rows={1} className="flex-1 bg-transparent outline-none py-4 px-4 resize-none" />
                                        <button onClick={() => handleSendMessage()} disabled={isSendDisabled} className={`w-12 h-12 mb-1 mr-1 rounded-full flex items-center justify-center ${isSendDisabled ? 'bg-gray-200' : 'bg-indigo-600 text-white'}`}><Send size={20} /></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
